---
title: 'Oocyte Alternative Splicing Analysis'
Subtitle: "Pladienolide B"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    code_folding: hide
    code_download: false
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options:
  markdown:
    wrap: 72


header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        #logos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #logos img {
            height: 80px;
            margin: 0 15px;
        }
     </style>'
---



```{css, echo=FALSE}
/* Minimal and clean custom CSS */
body {
  font-family: 'Roboto', sans-serif;
  color: #333; /* Neutral dark gray for body text */
  background-color: #f9f9f9; /* Light background */
  margin: 0;
  padding: 0;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto', sans-serif;
  font-weight: bold;
}

/* Header Colors */
h1 {
  font-size: 2.5em;
  color: #5E14C4; /* Main headers in purple */
}

h2 {
  font-size: 2em;
  color: #4A10A1; /* Darker purple for secondary headers */
}

h3 {
  font-size: 1.75em;
  color: #3B0D7E; /* Even darker purple for tertiary headers */
}

p {
  text-align: justify;
  line-height: 1.6;
  margin: 0 0 1em;
}

/* Styling for subtitle, authors, and date */
.subtitle, .author, .date {
  color: #5E14C4;
  font-size: 1.25em;
  text-align: center;
  margin-bottom: 0.5em;
}

/* Link styling */
a {
  color: #5E14C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Table styling */
table {
  border-collapse: collapse;
  width: 100%;
  margin: 20px 0;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 10px;
}

table th {
  background-color: #5E14C4;
  color: white;
}

table tr:nth-child(even) {
  background-color: #f9f9f9;
}

table tr:hover {
  background-color: #f1f1f1;
}

```



```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)


# Load required libraries
library("betAS")
library("ggplot2")
library("plotly")
library("dplyr")
library("tidyverse")
library("cowplot")
library("DT")
library("paletteer")
library("ggupset")
library("showtext")
library("ggtext")
library("readxl")
library("biomaRt")
library("enrichR")
library("patchwork")
library("org.Mm.eg.db")
library("org.Hs.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ComplexHeatmap")
library("enrichR")
library("colorRamp2")
library("dendextend")
# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"


```

# Introduction to this Analysis


## Part 1: Upstream Analysis

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**:
  - Downloading `*.fastq.gz` files from 3 different studies:
    - **Pladienolide B (PladB) treated Oocytes**
  - Merging technical replicates for superior sequencing depth

2. **Alignment**:
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## Part 2: Statistical Analysis

### Objective
To identify splicing events that are differentially spliced in Oocytes treated with PladB with two differentes doses.

### Steps

1. **Statistical Testing**:
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform Beta Distribution simulations, T-test and ANOVA to obtain:
     - **False Discovery Rate (FDR)**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.01**


3. **Batch Effect Mitigation**:
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation. All exon related events (C1,C2,C3,S,including microexons) will be collapsed into a single list, EX.

---

## Importing Inclusion Data

```{r inclusion tables}
pladb_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/pladb_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
pladb_events <- getEvents(pladb_data, tool = "vast-tools") # Extract alternative splicing events
pladb_exons <- filterEvents(pladb_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
pladb_alt <- filterEvents(pladb_events, types = c("Alt5", "Alt3"), N = 2)
pladb_introns <- filterEvents(pladb_events, types = c("IR"), N = 2)
```


## Metadata { .tabset}

### PladB

```{r metadata pladb}
# Load metadata file containing sample information
metadata_pladb <- read.csv(paste0(getwd(),"/metadata/metadata_pladb.csv"), sep = "\t")
metadata_pladb<-metadata_pladb[seq(1, nrow(metadata_pladb), by = 2),]
DT::datatable(metadata_pladb, options = list(pageLength = nrow(metadata_pladb), scrollX = TRUE))
```


---

# Total Splicing Events

This plot shows the total number of splicing events found during the **mapping**, alongside the proportions of each type of event. It is important to know that *vast-tools* does not find new events, but it identifies those manually curated in the database.

```{r splicing events barplot stacked}

# Adjusted version of the script
splicing_events <- tibble(
  event_type = names(pladb_events$EventsPerType),
  pladb = pladb_events$EventsPerType
)

splicing_events_long <- splicing_events %>%
  pivot_longer(cols = c(pladb),
               names_to = "study", values_to = "count") %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

# Proportion bar plot
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) +
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "<b style='font-size:18px;'>Proportion of Splicing Events by Study</b>",
    x = NULL,
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal(base_family = font) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_markdown(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5)
  ) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

splicing_events_long_sum<-splicing_events_long %>%
  dplyr::group_by(study) %>%
  summarize(count = sum(count))


# Absolute counts plot
plot_absolute <- ggplot(splicing_events_long_sum, aes(y = count, x = study)) +
  geom_point(color = "#C70039", size = 3) +
  geom_text(aes(label = count), vjust = -1, size = 4, check_overlap = TRUE) +
  labs(
    x = "Study",
    y = "Number of Events",
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text( size=15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2)))


# Combine plots
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.5)) &
  theme(plot.margin = margin(5,5, 0, 5))

# Display combined plot
combined_plot
```



```{r general stats}

vastdb_events<-read.table("EVENT_INFO-mm10.tab", header = TRUE, sep = "\t")
bin_exons <- function(n) {
  if (is.na(n)) return(NA) # Handle missing values
  else if (n < 6) return("1-5")
  else if (n < 9) return("6-10")
  else if (n < 21) return("11-20")
  else return("21+")
}

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_exons<-vastdb_events[grep("EX", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$exon_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_exons<-apply_bin_exons(vastdb_exons)

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_introns<-vastdb_events[grep("IN", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$intron_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_introns<-apply_bin_exons(vastdb_introns)

```

# Splicing & Sample Quality Checking

Splicing inclusion plots look like a ***U*** when looking at the *exons*, as normally most of them are spliced out completely (PSI=0) or constitutively spliced in (PSI=1), but some of them are in between (alternatively spliced). Those are the most interesting for the analysis. On the other hand, *introns* are usually not included (that is their definition), but in a few cases they are included. Thus, the intron plot looks like the exponential distribution.

## PladB 10mm vs Control PSI Plot 

This is used to check if there is higher intron retention after pladb treatment. The plot shows the PSI of PladB 10mM vs the Control.

```{r intron retention checking}
pladb_exons$PSI %>%
  filter(!is.na(EVENT)) %>%
  select(EVENT, contains("X2022")) %>%
  pivot_longer(-EVENT, names_to = "sample", values_to = "PSI") %>%
  mutate(grp = ifelse(grepl("38|39|40", sample, perl = TRUE), "CTR",
                      ifelse(grepl("41|42|43", sample, perl = TRUE), "mm1", "PladB10mM"))) %>%
  group_by(grp, EVENT) %>%
  reframe(mPSI = mean(PSI)) %>%
  pivot_wider(id_cols = "EVENT", names_from = "grp", values_from = "mPSI") %>%
  filter(PladB10mM != 0 & CTR != 0) %>%
  ggplot(aes(x = CTR, y = PladB10mM)) +
  geom_point(aes(color = ifelse(PladB10mM > CTR, "above", "below")), size = 0.5) +
  scale_color_manual(values = c("above" = "lightcoral", "below" = "lightblue")) +
  labs(color = "Position") +
  theme_minimal()

```




## Does the number of exons of a gene affect Inclusion? { .tabset}

First I classified the genes according to the number of exons they contain from VASTDB. Then I plotted the dPSI of all exons grouped by that classification.

### Exons 


```{r inclusionumber of exons pladb}
pladb_exons_df<-na.omit(pladb_exons$PSI)
pladb_exons_df$exon_group<-vastdb_exons$exon_group[match(pladb_exons_df$EVENT,vastdb_exons$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_10mm <- rowMeans(df[, 13:15])
  avg_control <- rowMeans(df[, 7:9])
  avg_10mm - avg_control
}

# Compute the difference and group by exon groups
pladb_exons_df$difference <- compute_difference(pladb_exons_df)

pladb_exons_df$exon_group<-factor(pladb_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))

# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  na.omit(pladb_exons_df[abs(pladb_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "PladB, dPSI = 10mm - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```

## Introns

```{r inclusionumber of introns pladb}
pladb_introns_df<-na.omit(pladb_introns$PSI)
pladb_introns_df$intron_group<-vastdb_introns$intron_group[match(pladb_introns_df$EVENT,vastdb_introns$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 10:12])
  avg_control <- rowMeans(df[, 7:9])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
pladb_introns_df$difference <- compute_difference(pladb_introns_df)


# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  na.omit(pladb_introns_df[abs(pladb_introns_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 100, position = "identity") +
  facet_wrap(~intron_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "Spire, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```



## PCA Plot { .tabset}

### PladB

```{r pca calculation}
# Subset and scale data
pca_pladb <- pladb_data[, c("EVENT",pladb_events$Samples)] %>%
  na.omit()

rownames(pca_pladb)<- pca_pladb$EVENT
pca_pladb<-t(pca_pladb[,-1])


pca_result_pladb <- prcomp(pca_pladb)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result_pladb$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-metadata_pladb$Description
```

```{r pca plotting}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), )) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result_pladb)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result_pladb)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  coord_fixed()

pca_plot

```


# Differential Splicing Calculation

```{r aux_featuregroup}
# Extract unique groups and sample IDs
# pladb

groupingVariable <- "Description"


groups_pladb <- unique(metadata_pladb[, groupingVariable])
samples_pladb <- metadata_pladb$fastq_files
samples_pladb <- paste0(
  "X",
  sub("\\.fastq\\.gz$", "", samples_pladb),
  "_merged"
)


random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")

# Create group list with metadata
groupList_pladb <- lapply(1:length(groups_pladb), function(i) {
  list(
    name = groups_pladb[i],
    samples = samples_pladb[metadata_pladb[, groupingVariable] == groups_pladb[i]],
    color = random_colors[i]
  )
})
names(groupList_pladb) <- groups_pladb

```

```{r groups_auxiliary}
# Define groups
groupA_pladb    <- "ControlFmn2+-"
groupC_pladb    <- "Fmn2+-_+1mMPlatB"
groupB_pladb <- "Fmn2+-_+10mMPlatB"

# Define samples inside each group
samplesA_pladb    <- groupList_pladb[[groupA_pladb]]$samples
samplesB_pladb    <- groupList_pladb[[groupB_pladb]]$samples
samplesC_pladb    <- groupList_pladb[[groupC_pladb]]$samples
colsGroupA_pladb    <- convertCols(pladb_exons$PSI, samplesA_pladb)
colsGroupB_pladb   <- convertCols(pladb_exons$PSI, samplesB_pladb)
colsGroupC_pladb   <- convertCols(pladb_exons$PSI, samplesC_pladb)

```

## Exon Lists

### Calculations

```{r pdiff calculation exons}
pladb_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupB_pladb,
  labA = groupA_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_control_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupC_pladb,
  labA = groupA_pladb,
  labB = groupC_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_10mm_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupC_pladb,
  colsB = colsGroupB_pladb,
  labA = groupC_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed=TRUE,
  CoverageWeight = FALSE)

write.csv(pladb_pdiff_exons,"pladb_pdiff_exons.csv")
write.csv(pladb_1mm_control_pdiff_exons,"pladb_1mm_control_pdiff_exons.csv")
write.csv(pladb_1mm_10mm_pdiff_exons,"pladb_1mm_10mm_pdiff_exons.csv")

```




### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.

#### PladB 10mM vs Control

```{r pladb fdr volcano exons 10mm control}
# INtersecting dhared exons between 10mm vs control and 1mm vs control
differential_pladb10mm_exons<-na.omit(pladb_pdiff_exons[pladb_pdiff_exons$FDR<=0.01 & abs(pladb_pdiff_exons$deltapsi)>=0.1,])
differential_pladb1mm_exons<-na.omit(pladb_1mm_control_pdiff_exons[pladb_1mm_control_pdiff_exons$FDR<=0.01 & abs(pladb_1mm_control_pdiff_exons$deltapsi)>=0.1,])
differential_pladb10mm_1mm_exons<-na.omit(pladb_1mm_10mm_pdiff_exons[pladb_1mm_10mm_pdiff_exons$FDR<=0.01 & abs(pladb_1mm_10mm_pdiff_exons$deltapsi)>=0.1,])

shared_exons<-differential_pladb10mm_exons$EVENT[differential_pladb10mm_exons$EVENT %in% differential_pladb1mm_exons$EVENT]

# Volcano plot
library(ggrepel)
pladb_pdiff_exons<-na.omit(pladb_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_pdiff_exons$Shared <- ifelse(pladb_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_pdiff_exons$Significant <- ifelse(
  pladb_pdiff_exons$FDR<=0.01 & pladb_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_pdiff_exons$FDR<=0.01 & pladb_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_pdiff_exons$negLogpvalue <- -log10(pladb_pdiff_exons$FDR)


volcano_plot <- ggplot(pladb_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - control) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)

volcano_plot


```

#### PladB 1mM vs Control

```{r pladb fdr volcano exons 1mm control}
pladb_1mm_control_pdiff_exons<-na.omit(pladb_1mm_control_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_1mm_control_pdiff_exons$Shared <- ifelse(pladb_1mm_control_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_1mm_control_pdiff_exons$Significant <- ifelse(
  pladb_1mm_control_pdiff_exons$FDR<=0.01 & pladb_1mm_control_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_control_pdiff_exons$FDR<=0.01 & pladb_1mm_control_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_control_pdiff_exons$negLogpvalue <- -log10(pladb_1mm_control_pdiff_exons$FDR)


volcano_plot <- ggplot(pladb_1mm_control_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (1mm - control) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```

#### PladB 10mM vs 1mM

```{r pladb fdr volcano exons 10mm 1mm}
pladb_1mm_10mm_pdiff_exons<-na.omit(pladb_1mm_10mm_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_1mm_10mm_pdiff_exons$Shared <- ifelse(pladb_1mm_10mm_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_1mm_10mm_pdiff_exons$Significant <- ifelse(
  pladb_1mm_10mm_pdiff_exons$FDR<=0.01 & pladb_1mm_10mm_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_10mm_pdiff_exons$FDR<=0.01 & pladb_1mm_10mm_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_10mm_pdiff_exons$negLogpvalue <- -log10(pladb_1mm_10mm_pdiff_exons$FDR)



volcano_plot <- ggplot(pladb_1mm_10mm_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - 1mm) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)

# Display the plot
volcano_plot

```

#### Dynamics of Shared Exons

```{r dynamics shraed exons}
shared_exons_df <- data.frame(
  Event = shared_exons,
  control = rep(0, length(shared_exons)),
  PladB_1mm = 0 + pladb_1mm_control_pdiff_exons$deltapsi[pladb_1mm_control_pdiff_exons$EVENT %in% shared_exons]
)
shared_exons_df$PladB_10mm <- shared_exons_df$PladB_1mm + pladb_1mm_10mm_pdiff_exons$deltapsi[pladb_1mm_10mm_pdiff_exons$EVENT %in% shared_exons]
shared_exons_df <- pivot_longer(shared_exons_df, cols = 2:4, names_to = "dose")
shared_exons_df$dose <- factor(shared_exons_df$dose, levels = c("control", "PladB_1mm", "PladB_10mm"))

# Plot
dose_dependent_plot<-ggplot(shared_exons_df, aes(x = dose, y = value, group = Event, color = Event)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # Horizontal line at y=0
  geom_line(size = 1, alpha = 0.7) + # Connect points with lines
  geom_point(size = 3, alpha = 0.8) + # Points for emphasis
  facet_wrap(~ Event, scales = "fixed") + # Facet by Event
  labs(
    title = "Dose-Dependent Changes in Exons deltaPSI",
    x = "Dose",
    y = "ΔPSI",
    color = "Event"
  ) +
  theme_minimal(base_size = 15) + # Clean, professional theme
  theme(
    strip.text = element_text(face = "bold"), # Highlight Event labels
    legend.position = "none", # Remove legend for clarity in facets
    axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels
  )


dose_dependent_plot
```

### Individual Combination Tables { .tabset}

These tables show the exons that show a FDR<=0.1 in the pairwise comparison of each condition.


#### PladB 10mM vs control


```{r pladb combination table exons 10mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```

#### PladB 1mM vs Control

```{r pladb combination table exons 1mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb1mm_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### PladB 10mM vs 1mM

```{r pladb combination table exons 10mm 1mm}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_1mm_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


#### Shared Exons in 10mM vs control & 1mM vs control

```{r pladb combination table exons shared}
shared_exons_datatable<-pladb_pdiff_exons[pladb_pdiff_exons$EVENT %in% shared_exons,]
# Render DataTable with enhancements
datatable(
  shared_exons_datatable,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

## Intron Lists

### Calculations

```{r pdiff calculation introns}
pladb_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupB_pladb,
  labA = groupA_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

pladb_1mm_control_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupC_pladb,
  labA = groupA_pladb,
  labB = groupC_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

pladb_1mm_10mm_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupC_pladb,
  colsB = colsGroupB_pladb,
  labA = groupC_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

write.csv(pladb_pdiff_introns,"pladb_pdiff_introns.csv")
write.csv(pladb_1mm_control_pdiff_introns,"pladb_1mm_control_pdiff_introns.csv")
write.csv(pladb_1mm_10mm_pdiff_introns,"pladb_1mm_10mm_pdiff_introns.csv")
```


### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.

#### PladB 10mM vs Control

```{r pladb fdr volcano introns 10mm control}
# INtersecting dhared introns between 10mm vs control and 1mm vs control
differential_pladb10mm_introns<-na.omit(pladb_pdiff_introns[pladb_pdiff_introns$FDR<=0.01 & abs(pladb_pdiff_introns$deltapsi) >= 0.1,])
differential_pladb1mm_introns<-na.omit(pladb_1mm_control_pdiff_introns[pladb_1mm_control_pdiff_introns$FDR<=0.01 & abs(pladb_1mm_control_pdiff_introns$deltapsi) >= 0.1,])

differential_pladb10mm_1mm_introns<-na.omit(pladb_1mm_10mm_pdiff_introns[pladb_1mm_10mm_pdiff_introns$FDR<=0.01 & abs(pladb_1mm_10mm_pdiff_introns$deltapsi) >= 0.1,])

shared_introns<-differential_pladb10mm_introns$EVENT[differential_pladb10mm_introns$EVENT %in% differential_pladb1mm_introns$EVENT]

# Volcano plot
library(ggrepel)
pladb_pdiff_introns<-na.omit(pladb_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_pdiff_introns$Shared <- ifelse(pladb_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_pdiff_introns$Significant <- ifelse(
  pladb_pdiff_introns$FDR<=0.01 & pladb_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_pdiff_introns$FDR<=0.01 & pladb_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_pdiff_introns$negLogpvalue <- -log10(pladb_pdiff_introns$FDR)


volcano_plot <- ggplot(pladb_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - control) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```

#### PladB 1mM vs Control

```{r pladb fdr volcano introns 1mm control}
pladb_1mm_control_pdiff_introns<-na.omit(pladb_1mm_control_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_1mm_control_pdiff_introns$Shared <- ifelse(pladb_1mm_control_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_1mm_control_pdiff_introns$Significant <- ifelse(
  pladb_1mm_control_pdiff_introns$FDR<=0.01 & pladb_1mm_control_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_control_pdiff_introns$FDR<=0.01 & pladb_1mm_control_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_control_pdiff_introns$negLogpvalue <- -log10(pladb_1mm_control_pdiff_introns$FDR)


volcano_plot <- ggplot(pladb_1mm_control_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (1mm - control) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```

#### PladB 10mM vs 1mM

```{r pladb fdr volcano introns 10mm 1mm}
pladb_1mm_10mm_pdiff_introns<-na.omit(pladb_1mm_10mm_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_1mm_10mm_pdiff_introns$Shared <- ifelse(pladb_1mm_10mm_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_1mm_10mm_pdiff_introns$Significant <- ifelse(
  pladb_1mm_10mm_pdiff_introns$FDR<=0.01 & pladb_1mm_10mm_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_10mm_pdiff_introns$FDR<=0.01 & pladb_1mm_10mm_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_10mm_pdiff_introns$negLogpvalue <- -log10(pladb_1mm_10mm_pdiff_introns$FDR)


volcano_plot <- ggplot(pladb_1mm_10mm_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - 1mm) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)

# Display the plot
volcano_plot

```


#### Dynamics of Shared Introns

```{r dynamics shraed introns}
shared_introns_df <- data.frame(
  Event = shared_introns,
  control = rep(0, length(shared_introns)),
  PladB_1mm = 0 + pladb_1mm_control_pdiff_introns$deltapsi[pladb_1mm_control_pdiff_introns$EVENT %in% shared_introns]
)
shared_introns_df$PladB_10mm <- shared_introns_df$PladB_1mm + pladb_1mm_10mm_pdiff_introns$deltapsi[pladb_1mm_10mm_pdiff_introns$EVENT %in% shared_introns]
shared_introns_df <- pivot_longer(shared_introns_df, cols = 2:4, names_to = "dose")
shared_introns_df$dose <- factor(shared_introns_df$dose, levels = c("control", "PladB_1mm", "PladB_10mm"))

# Plot
dose_dependent_plot<-ggplot(shared_introns_df, aes(x = dose, y = value, group = Event, color = Event)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # Horizontal line at y=0
  geom_line(size = 1, alpha = 0.7) + # Connect points with lines
  geom_point(size = 3, alpha = 0.8) + # Points for emphasis
  facet_wrap(~ Event, scales = "fixed") + # Facet by Event
  labs(
    title = "Dose-Dependent Changes in Introns deltaPSI",
    x = "Dose",
    y = "ΔPSI",
    color = "Event"
  ) +
  theme_minimal(base_size = 15) + # Clean, professional theme
  theme(
    strip.text = element_text(face = "bold"), # Highlight Event labels
    legend.position = "none", # Remove legend for clarity in facets
    axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels
  )


dose_dependent_plot
```





### Individual Combination Tables { .tabset}

These tables show the introns that show a FDR<=0.1 in the pairwise comparison of each condition.

#### PladB 10mM vs control


```{r pladb combination table introns 10mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```

#### PladB 1mM vs Control


```{r pladb combination table introns 1mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb1mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### PladB 10mM vs 1mM


```{r pladb combination table introns 10mm 1mm}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_1mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


#### Shared Introns in 10mM vs control & 1mM vs control

```{r pladb combination table introns shared}
# Render DataTable with enhancements
shared_introns_datatable<-pladb_pdiff_introns[pladb_pdiff_introns$EVENT %in% shared_introns,]
datatable(
  shared_introns_datatable,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


## Alternative 5´ and 3´ Lists

### Calculations

```{r pdiff calculation alt}
pladb_pdiff_alt <- prepareTableVolcanoFDR(
  psitable = pladb_alt$PSI,
  qualtable = pladb_alt$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupB_pladb,
  labA = groupA_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

pladb_1mm_control_pdiff_alt <- prepareTableVolcanoFDR(
  psitable = pladb_alt$PSI,
  qualtable = pladb_alt$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupC_pladb,
  labA = groupA_pladb,
  labB = groupC_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

pladb_1mm_10mm_pdiff_alt <- prepareTableVolcanoFDR(
  psitable = pladb_alt$PSI,
  qualtable = pladb_alt$Qual,
  npoints = 500,
  colsA = colsGroupC_pladb,
  colsB = colsGroupB_pladb,
  labA = groupC_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 


write.csv(pladb_pdiff_alt,"pladb_pdiff_alt.csv")
write.csv(pladb_1mm_control_pdiff_alt,"pladb_1mm_control_pdiff_alt.csv")
write.csv(pladb_1mm_10mm_pdiff_alt,"pladb_1mm_10mm_pdiff_alt.csv")
```


### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.

#### PladB 10mM vs Control

```{r pladb fdr volcano alt 10mm control}
# INtersecting dhared alt between 10mm vs control and 1mm vs control
differential_pladb10mm_alt<-na.omit(pladb_pdiff_alt[pladb_pdiff_alt$FDR<=0.01 & abs(pladb_pdiff_alt$deltapsi) >= 0.1,])
differential_pladb1mm_alt<-na.omit(pladb_1mm_control_pdiff_alt[pladb_1mm_control_pdiff_alt$FDR<=0.01 & abs(pladb_1mm_control_pdiff_alt$deltapsi) >= 0.1,])

differential_pladb10mm_1mm_alt<-na.omit(pladb_1mm_10mm_pdiff_alt[pladb_1mm_10mm_pdiff_alt$FDR<=0.01 & abs(pladb_1mm_10mm_pdiff_alt$deltapsi) >= 0.1,])

shared_alt<-differential_pladb10mm_alt$EVENT[differential_pladb10mm_alt$EVENT %in% differential_pladb1mm_alt$EVENT]

# Volcano plot
library(ggrepel)
pladb_pdiff_alt<-na.omit(pladb_pdiff_alt)
# Add a Shared column based on the shared_alt
pladb_pdiff_alt$Shared <- ifelse(pladb_pdiff_alt$EVENT %in% shared_alt, "Shared", "Not Shared")

# Classify significance
pladb_pdiff_alt$Significant <- ifelse(
  pladb_pdiff_alt$FDR<=0.01 & pladb_pdiff_alt$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_pdiff_alt$FDR<=0.01 & pladb_pdiff_alt$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_pdiff_alt$negLogpvalue <- -log10(pladb_pdiff_alt$FDR)


volcano_plot <- ggplot(pladb_pdiff_alt, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - control) Alt 5´ & 3´",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```

#### PladB 1mM vs Control

```{r pladb fdr volcano alt 1mm control}
pladb_1mm_control_pdiff_alt<-na.omit(pladb_1mm_control_pdiff_alt)
# Add a Shared column based on the shared_alt
pladb_1mm_control_pdiff_alt$Shared <- ifelse(pladb_1mm_control_pdiff_alt$EVENT %in% shared_alt, "Shared", "Not Shared")

# Classify significance
pladb_1mm_control_pdiff_alt$Significant <- ifelse(
  pladb_1mm_control_pdiff_alt$FDR<=0.01 & pladb_1mm_control_pdiff_alt$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_control_pdiff_alt$FDR<=0.01 & pladb_1mm_control_pdiff_alt$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_control_pdiff_alt$negLogpvalue <- -log10(pladb_1mm_control_pdiff_alt$FDR)



volcano_plot <- ggplot(pladb_1mm_control_pdiff_alt, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (1mm - control) Alt 5´ & 3´",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```

#### PladB 10mM vs 1mM

```{r pladb fdr volcano alt 10mm 1mm}
pladb_1mm_10mm_pdiff_alt<-na.omit(pladb_1mm_10mm_pdiff_alt)
# Add a Shared column based on the shared_alt
pladb_1mm_10mm_pdiff_alt$Shared <- ifelse(pladb_1mm_10mm_pdiff_alt$EVENT %in% shared_alt, "Shared", "Not Shared")

# Classify significance
pladb_1mm_10mm_pdiff_alt$Significant <- ifelse(
  pladb_1mm_10mm_pdiff_alt$FDR<=0.01 & pladb_1mm_10mm_pdiff_alt$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_10mm_pdiff_alt$FDR<=0.01 & pladb_1mm_10mm_pdiff_alt$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_10mm_pdiff_alt$negLogpvalue <- -log10(pladb_1mm_10mm_pdiff_alt$FDR)



volcano_plot <- ggplot(pladb_1mm_10mm_pdiff_alt, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,         # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,           # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Pladb (10mm - 1mm) Alt 5´ & 3´",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", color = "black"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, face = "italic", color = "gray30"),
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    legend.text = element_text(size = 12),
    legend.title = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    panel.border = element_blank()  # Remove the built-in border
  ) +
  # Increase y-axis space at the top:
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)), limits = c(0, NA)) +
  # Add back left, bottom, and right borders:
  geom_segment(aes(x = -Inf, xend = Inf, y = -Inf, yend = -Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = -Inf, xend = -Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1) +
  geom_segment(aes(x = Inf, xend = Inf, y = -Inf, yend = Inf),
               inherit.aes = FALSE, color = "black", size = 1)
# Display the plot
volcano_plot

```




### Individual Combination Tables { .tabset}

These tables show the alt that show a FDR<=0.1 in the pairwise comparison of each condition.


#### PladB 10mM vs control


```{r pladb combination table alt 10mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_alt,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```

#### PladB 1mM vs Control


```{r pladb combination table alt 1mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb1mm_alt,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### PladB 10mM vs 1mM


```{r pladb combination table alt 10mm 1mm}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_1mm_alt,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


#### Shared Alt in 10mM vs control & 1mM vs control

```{r pladb combination table alt shared}
# Render DataTable with enhancements
shared_alt_datatable<-pladb_pdiff_alt[pladb_pdiff_alt$EVENT %in% shared_alt,]
datatable(
  shared_alt_datatable,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```



## PSI Distribution Plots { .tabset}

These plots aim to explore any enrichment of either (intron/exon) retention or (intron/exon) exclusion. Symmetric plots show that inclusion and retention are equally common between conditions. Only showing events with |dPSI|>=0.1 for higher clarity. It shows the density (proportion) for each subplot, or the total counts.

### PladB Density

```{r splicing distribution plot, fig.width=10}

# List of dataframes with metadata
dfs <- list(
  list(df = pladb_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_exons, group = "Exons", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_1mm"),
  list(df = pladb_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_introns, group = "Introns", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_1mm"),
   list(df = pladb_pdiff_alt, group = "Alt5/Alt3", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_alt, group = "Alt5/Alt3", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_alt, group = "Alt5/Alt3", study = "PladB_10mM_vs_1mm")
)

# Add metadata columns to each dataframe beforehand
dfs_with_metadata <- lapply(dfs, function(x) {
  x$df %>%
    mutate(Group = x$group, Study = x$study)
})

# Combine all dataframes into one using bind_rows() for faster merging
final_df <- bind_rows(dfs_with_metadata) %>%
  select(EVENT, Group, Study, deltapsi) %>%
  filter(abs(deltapsi)>=0.1) %>%
  na.omit()# Adjust this line if other columns should be prioritized


plot_psi_distribution <- ggplot(final_df, aes(y=..density..,x = deltapsi, fill = ifelse(deltapsi < 0, "Skipped", "Included"))) +
  geom_histogram( bins = 100, position = "identity") +
  labs(
    title = "PSI Distribution in PladB treated samples",
    x = "ΔPSI",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~Group*Study)

plot_psi_distribution
```


### PladB Total Counts

```{r splicing distribution plot alt, fig.width=10}

# List of dataframes with metadata
dfs <- list(
  list(df = pladb_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_exons, group = "Exons", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_1mm"),
  list(df = pladb_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_introns, group = "Introns", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_1mm"),
   list(df = pladb_pdiff_alt, group = "Alt5/Alt3", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_alt, group = "Alt5/Alt3", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_alt, group = "Alt5/Alt3", study = "PladB_10mM_vs_1mm")
)

# Add metadata columns to each dataframe beforehand
dfs_with_metadata <- lapply(dfs, function(x) {
  x$df %>%
    mutate(Group = x$group, Study = x$study)
})

# Combine all dataframes into one using bind_rows() for faster merging
final_df <- bind_rows(dfs_with_metadata) %>%
  select(EVENT, Group, Study, deltapsi) %>%
  filter(abs(deltapsi)>=0.1) %>%
  na.omit()# Adjust this line if other columns should be prioritized


plot_psi_distribution <- ggplot(final_df, aes(x = deltapsi, fill = ifelse(deltapsi < 0, "Skipped", "Included"))) +
  geom_histogram( bins = 100, position = "identity") +
  labs(
    title = "PSI Distribution in PladB treated samples",
    x = "ΔPSI",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~Group*Study)

plot_psi_distribution
```

## Enrichment Analysis with EnrichR { .tabset}

### Gene Ontology of all genes differentially spliced under any dose compared to control.

```{r pladb enrichr alt}
enrichdata<-enrichr(unique(c(differential_pladb10mm_exons$GENE,differential_pladb1mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_introns$GENE,differential_pladb10mm_alt$GENE,differential_pladb1mm_alt$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))
```

#### GO Biological Process

```{r pladb bioprocessn alt, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r pladb cellcomponent alt, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r pladb molfunction alt, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

### PladB 10mM vs 1mM { .tabset}

```{r pladb enrichr 10mm 1mm}
enrichdata<-enrichr(unique(c(differential_pladb10mm_1mm_introns$GENE, differential_pladb10mm_1mm_exons$GENE,differential_pladb10mm_1mm_alt$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))
```

#### GO Biological Process

```{r pladb bioprocess 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r pladb cellcomponent 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r pladb molfunction 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# Gene-centric Analysis

```{r gene-centric plot}
set.seed(44)
protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")
# -------------------------------
# 1. Combine data and add protein impact
# -------------------------------
combined_df <- bind_rows(
  exons_10mm  = differential_pladb10mm_exons,
  exons_1mm   = differential_pladb1mm_exons,
  introns_10mm= differential_pladb10mm_introns,
  introns_1mm = differential_pladb1mm_introns,
  .id = "source"   # new column indicating the origin
) %>% 
  select(-X)

# Match the protein impact values
combined_df$protein_impact <- protein_impact$ONTO[match(combined_df$EVENT, protein_impact$EventID)]

# select only unqiue values in GENE
combined_df <- combined_df %>% distinct(EVENT, .keep_all = TRUE)
# -------------------------------
# 2. Create per-gene summary data
# -------------------------------
combined_df_summary <- combined_df %>%
  distinct(GENE, EVENT, .keep_all = TRUE) %>%  # remove duplicate gene/event rows if any
  group_by(GENE) %>%
  summarise(
    nEvents   = n(),                                        # number of events per gene
    meanDelta = mean(abs(deltapsi), na.rm = TRUE),          # mean absolute deltapsi
    sdDelta   = sd(abs(deltapsi), na.rm = TRUE)             # standard deviation (for reference)
  ) %>%
  arrange(desc(nEvents), desc(meanDelta)) %>%              # sort so that genes with more events come first
  mutate(GENE = factor(GENE, levels = unique(GENE)))        # set the ordering for the x-axis

# -------------------------------
# 3. Update original data and join summary info
# -------------------------------
combined_df <- combined_df %>%
  mutate(
    absDelta = abs(deltapsi),
    impact   = ifelse(grepl("ORF", protein_impact, ignore.case = TRUE), "ORF", "Non-ORF")
  ) %>%
  left_join(combined_df_summary %>% select(GENE, nEvents), by = "GENE") %>%
  mutate(GENE = factor(GENE, levels = levels(combined_df_summary$GENE)))

# -------------------------------
# 4. Create custom facet strip labels (optional)
# -------------------------------
facet_labels <- combined_df_summary %>%
  group_by(nEvents) %>%
  summarise(n_genes = n()) %>%
  mutate(label = paste0(nEvents, " events (", n_genes, " genes)")) %>%
  deframe()  # a named vector mapping nEvents -> "n events (x genes)"

# -------------------------------
# 5. Create a mapping for x-axis labels: blank out gene names for nEvents==1 or 2
# -------------------------------
gene_labels <- combined_df_summary %>%
  mutate(gene_label = ifelse(nEvents %in% c(1, 2), "", as.character(GENE))) %>%
  select(GENE, gene_label) %>%
  deframe()

# -------------------------------
# 6. Create annotation data for facets with nEvents 1 and 2
# -------------------------------
annotation_df <- combined_df_summary %>%
  filter(nEvents %in% c(1, 2)) %>%
  group_by(nEvents) %>%
  summarise(
    n_genes      = n(),
    max_meanDelta= max(meanDelta)
  ) %>%
  # Here we compute an approximate x-location (center of the facet)
  # Note: In a free_x facet the bars are placed at positions 1,2,..., so (n_genes+1)/2 is roughly centered.
  mutate(
    x = (n_genes + 1) / 2,
    y = max_meanDelta * 1.05  # position the label slightly above the tallest bar in that facet
  )

# -------------------------------
# 7. Build the plot
# -------------------------------
p <- ggplot() +
  # Bar plot: summary values (mean absolute deltapsi) per gene
  geom_bar(
    data = combined_df_summary[-which(combined_df_summary$GENE==""),], 
    aes(x = GENE, y = meanDelta, fill = factor(nEvents)),
    stat = "identity", 
    width = 0.7, 
    alpha = 0.8
  ) +
  # Jitter: individual event values, with shape by protein impact
  geom_jitter(
    data = combined_df[-which(combined_df$GENE==""),],
    aes(x = GENE, y = absDelta, shape = impact),
    width = 0.15,    # small horizontal jitter
    size = 2.5, 
    alpha = 0.6,
    color = "black"
  ) +
  # Add a text annotation in facets where nEvents==1 or 2 showing the number of genes
  geom_text(
    data = annotation_df,
    aes(x = x, y = y, label = paste(n_genes, "genes")),
    inherit.aes = FALSE,
    size = 5,
    color = "black"
  ) +
  # Use a color palette for the bars and manually define the shapes
  scale_fill_brewer(palette = "Set2", name = "Number of Events") +
  scale_shape_manual(values = c("Non-ORF" = 16, "ORF" = 17), name = "Protein Impact") +
  # Apply the custom x-axis labels (gene names only appear for genes with >2 events)
  scale_x_discrete(labels = gene_labels) +
  labs(
    x = "Gene ID",
    y = "|dPSI|",
    title = "Mean |dPSI| of genes grouped by the number significant Splicing Events"
  ) +
  theme_bw(base_size = 14) +
  theme(
    # Rotate x-axis labels (for facets that show them)
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    plot.title   = element_text(hjust = 0.5),
    # Improved facet strip aesthetics:
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text       = element_text(face = "bold"),
    panel.background = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  ) +
  # Facet the plot by the number of events (with free x-axis scales)
  facet_wrap(~ nEvents, scales = "free_x", labeller = labeller(nEvents = facet_labels))

# Display the plot
print(p)


```

# Nuclear Speckle Protein Splicing Correlation

Nuclear speckles genes were obtained from the Human Protein Atlas
Differentially spliced events were filtered to obtain those proteins localizing within speckles. I performed pearson correlation between those selected events. |dPSI|>=0.1

```{r nuclear spckeles data hadnling spire}
set.seed(43)
speckles_proteins <- read_tsv("nuclear_speckles_protein_human_atlas.tsv")

# Filter events based on gene names
pladb_speckle_prots <- pladb_events$PSI %>%
  filter(
    (EVENT %in% differential_pladb10mm_exons$EVENT[
      tolower(differential_pladb10mm_exons$GENE) %in% tolower(speckles_proteins$Gene) & 
      abs(differential_pladb10mm_exons$deltapsi) >= 0.1]) |
    
    (EVENT %in% differential_pladb10mm_introns$EVENT[
      tolower(differential_pladb10mm_introns$GENE) %in% tolower(speckles_proteins$Gene) & 
      abs(differential_pladb10mm_introns$deltapsi) >= 0.1]) |
    
    (EVENT %in% differential_pladb1mm_introns$EVENT[
      tolower(differential_pladb1mm_introns$GENE) %in% tolower(speckles_proteins$Gene) & 
      abs(differential_pladb1mm_introns$deltapsi) >= 0.1]) |
    
    (EVENT %in% differential_pladb1mm_exons$EVENT[
      tolower(differential_pladb1mm_exons$GENE) %in% tolower(speckles_proteins$Gene) & 
      abs(differential_pladb1mm_exons$deltapsi) >= 0.1])
  )

# Create a mapping between events and gene names
event_gene_map <- unique(dplyr::bind_rows(
  select(differential_pladb10mm_exons, EVENT, GENE),
  select(differential_pladb10mm_introns, EVENT, GENE),
  select(differential_pladb1mm_introns, EVENT, GENE),
  select(differential_pladb1mm_exons, EVENT, GENE)
))

# Merge to associate genes with the selected events
pladb_speckle_prots <- pladb_speckle_prots %>%
  left_join(event_gene_map, by = "EVENT")

# Update row names to include gene labels
rownames(pladb_speckle_prots) <- paste(pladb_speckle_prots$EVENT, pladb_speckle_prots$GENE.x, sep = " | ")

# Transpose the filtered matrix for correlation calculation
pladb_speckle_prots_t <- t(pladb_speckle_prots[, 7:15])

# Calculate correlation matrix
cor_matrix <- cor(pladb_speckle_prots_t)

# Create a heatmap with rotated x-axis labels
heatmap <- Heatmap(cor_matrix,
                   name = "Correlation",
                   clustering_distance_rows = "pearson",  # Row clustering method
                   clustering_method_rows = "complete",     # Clustering method for rows
                   show_row_dend = TRUE,                    # Show row dendrogram
                   show_column_dend = TRUE,                 # Show column dendrogram
                   column_title = "Correlation Heatmap",    # Title for the heatmap
                   row_title = "Variables",                 # Title for rows
                   column_title_gp = gpar(fontsize = 14),   # Title formatting
                   row_title_gp = gpar(fontsize = 14),      # Row title formatting
                   column_names_rot = 45                    # Rotate column labels by 45 degrees
)

# Draw the heatmap
draw(heatmap)

```

```{r table speckles pladb}
# Render DataTable with enhancements
datatable(
  pladb_speckle_prots              # Enable export buttons
)
```

# Splicing Dynamics Heatmap PladB

Only Exons and Introns cassettes, not Alt. From now, onwards, only events with |dPSI|>=0.1 are considered.

```{r heatmap prep 2, results='hide', fig.show='hide'}
set.seed(44)

# Extract all events
pladb_all <- filterEvents(
  pladb_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR","Alt3","Alt5"),
  N = 3
)

# Convert PSI values to a matrix and set row names
pladb_matrix <- pladb_all$PSI[, 7:15] %>%
  as.matrix()
rownames(pladb_matrix) <- pladb_all$PSI$EVENT

# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_pladb10mm_exons$EVENT[abs(differential_pladb10mm_exons$deltapsi)>=0.1],differential_pladb10mm_introns$EVENT[abs(differential_pladb10mm_introns$deltapsi)>=0.1],differential_pladb1mm_exons$EVENT[abs(differential_pladb1mm_exons$deltapsi)>=0.1],differential_pladb1mm_introns$EVENT[abs(differential_pladb1mm_introns$deltapsi)>=0.1]))
pladb_matrix <- pladb_matrix[rownames(pladb_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
colnames(pladb_matrix)<-metadata_pladb$fastq_files
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(pladb_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 3) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(pladb_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-8



reference_table<-data.frame(EVENT=c(differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb10mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns$EVENT), GENE=c(differential_pladb10mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb10mm_exons$GENE,differential_pladb1mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb1mm_introns$GENE))



ht<-Heatmap(
  pladb_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes PladB Samples at Different concentrations of PladB",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(pladb_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(pladb_matrix)

final_impact <- data.frame(EventID = rownames(pladb_matrix)) %>%  # Extract row names as EventID
  left_join(protein_impact %>% filter(EventID %in% events_for_impact), by = "EventID") %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))  # Fill missing ONTO values with 0

# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot 2, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  pladb_matrix,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 20))
  })
}


```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final 3}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- pladb_matrix[row_order, col_order]

final_impact_string<-protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  slice(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-dplyr::select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))

# 

```


### Same Heatmap but averaging PSI values from same condition

```{r heatmap_plot short 2, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

pladb_matrix_short <- cbind(
  rowMeans(pladb_matrix[, 1:3]),
  rowMeans(pladb_matrix[, 4:6]),
  rowMeans(pladb_matrix[, 7:9])
)

# Convert to matrix and print result
colnames(pladb_matrix_short) <- c("Control", "PladB_1mM", "PladB_10mM")

pladb_matrix_short <- pladb_matrix_short[row_order,]

ht <- Heatmap(
  pladb_matrix_short,
  name = "PSI",
  col = col_fun,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:3),
  cluster_rows = FALSE,   # <-- This disables row clustering
  cluster_columns = FALSE, # Optionally disable column clustering if desired
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"),      # Adjust the gap size between rows
  left_annotation = left_annotation[row_order],   # Add the points on the left
  right_annotation = right_annotation[row_order],
  column_gap = unit(4, "mm"),   # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend vertically
  )
)

# Draw the heatmap
ht <- draw(ht)

# Draw the heatmap




```



### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

orf_comparingcontrol_events<-unique(reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]])
```

#### GO Biological Process

```{r orf bioprocess fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```




# PladB 10mM vs Control UNIQUE (not shared with 1mM) events

```{r heatmap prep, results='hide', fig.show='hide'}
set.seed(44)


# Convert PSI values to a matrix and set row names
pladb_matrix <- pladb_all$PSI[, 7:15] %>%
  as.matrix()
rownames(pladb_matrix) <- pladb_all$PSI$EVENT


# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_pladb10mm_exons[!differential_pladb10mm_exons$EVENT %in% shared_exons,]$EVENT, differential_pladb10mm_introns[!differential_pladb10mm_introns$EVENT %in% shared_introns,]$EVENT))
pladb_matrix <- pladb_matrix[rownames(pladb_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
colnames(pladb_matrix)<-metadata_pladb$fastq_files
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(pladb_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 3) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(pladb_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-5


reference_table<-data.frame(EVENT=c(differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb10mm_1mm_introns$EVENT,differential_pladb10mm_1mm_exons$EVENT), GENE=c(differential_pladb10mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb1mm_introns$GENE,differential_pladb10mm_1mm_introns$GENE,differential_pladb10mm_1mm_exons$GENE))



ht<-Heatmap(
  pladb_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes PladB Samples at Different concentrations of PladB",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)

ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(pladb_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(pladb_matrix)

final_impact <- data.frame(EventID = rownames(pladb_matrix)) %>%  # Extract row names as EventID
  left_join(protein_impact %>% filter(EventID %in% events_for_impact), by = "EventID") %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))  # Fill missing ONTO values with 0


# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  pladb_matrix,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 20))
  })
}


```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- pladb_matrix[row_order, col_order]

final_impact_string<-protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-dplyr::select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))



```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr 2}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

orf_10mm_unique_exons<-differential_pladb10mm_exons[differential_pladb10mm_exons$EVENT %in% reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]],]

orf_10mm_unique_introns<-differential_pladb10mm_introns[differential_pladb10mm_introns$EVENT %in% reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]],]


```

#### GO Biological Process

```{r orf bioprocess 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

## ORF Disrupted Splicing Events unique to 10mM PladB

These are the mannually curated top splicing events that are unique to 10mM PladB treatment and witch a gene ontology related to cell cycle, chromosomes o spindle.

```{r densities_per_event 3, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- c("MmuEX0014857", "MmuEX0014855", "MmuINT0153506", 
          "MmuINT1032175","MmuEX0044981")
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1) +
  labs(
    title = "ORF Disrupted Events unique to 10mM PladB",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  ) + 
  facet_wrap(~EVENT)
```


# Splicing Dynamics Heatmap PladB

Only Exons and Introns cassettes, not Alt. From now, onwards, only events with |dPSI|>=0.1 are considered.

```{r heatmap prep 3, results='hide', fig.show='hide'}
set.seed(44)

# Extract all events
pladb_all <- filterEvents(
  pladb_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR","Alt3","Alt5"),
  N = 3
)

# Convert PSI values to a matrix and set row names
pladb_matrix <- pladb_all$PSI[, 7:15] %>%
  as.matrix()
rownames(pladb_matrix) <- pladb_all$PSI$EVENT

# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_pladb10mm_exons$EVENT[abs(differential_pladb10mm_exons$deltapsi)>=0.1],differential_pladb10mm_introns$EVENT[abs(differential_pladb10mm_introns$deltapsi)>=0.1],differential_pladb1mm_exons$EVENT[abs(differential_pladb1mm_exons$deltapsi)>=0.1],differential_pladb1mm_introns$EVENT[abs(differential_pladb1mm_introns$deltapsi)>=0.1]))
pladb_matrix <- pladb_matrix[rownames(pladb_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
colnames(pladb_matrix)<-metadata_pladb$fastq_files
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(pladb_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 3) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(pladb_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-8



reference_table<-data.frame(EVENT=c(differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb10mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns$EVENT), GENE=c(differential_pladb10mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb10mm_exons$GENE,differential_pladb1mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb1mm_introns$GENE))



ht<-Heatmap(
  pladb_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes PladB Samples at Different concentrations of PladB",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(pladb_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(pladb_matrix)

final_impact <- data.frame(EventID = rownames(pladb_matrix)) %>%  # Extract row names as EventID
  left_join(protein_impact %>% filter(EventID %in% events_for_impact), by = "EventID") %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))  # Fill missing ONTO values with 0

# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot 4, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  pladb_matrix,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 20))
  })
}


```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final 2}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- pladb_matrix[row_order, col_order]

final_impact_string<-protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  slice(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-dplyr::select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))

# 

```


### Same Heatmap but averaging PSI values from same condition

```{r heatmap_plot short, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

pladb_matrix_short <- cbind(
  rowMeans(pladb_matrix[, 1:3]),
  rowMeans(pladb_matrix[, 4:6]),
  rowMeans(pladb_matrix[, 7:9])
)

# Convert to matrix and print result
colnames(pladb_matrix_short) <- c("Control", "PladB_1mM", "PladB_10mM")

pladb_matrix_short <- pladb_matrix_short[row_order,]

ht <- Heatmap(
  pladb_matrix_short,
  name = "PSI",
  col = col_fun,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:3),
  cluster_rows = FALSE,   # <-- This disables row clustering
  cluster_columns = FALSE, # Optionally disable column clustering if desired
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"),      # Adjust the gap size between rows
  left_annotation = left_annotation[row_order],   # Add the points on the left
  right_annotation = right_annotation[row_order],
  column_gap = unit(4, "mm"),   # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend vertically
  )
)

# Draw the heatmap
ht <- draw(ht)

# Draw the heatmap




```


# Metascape Ontology Analysis { .tabset}

## Cell Cycle related


```{r cell cycle genes plot}
set.seed(44)
metascape_alltocontrol <- read_excel("metascape_allgenes_alldosesvscontrol.xlsx")
metascape_allgenes_10mmvscontrol <- read_excel("metascape_allgenes_10mmvscontrol.xlsx")

cell_cycle_genes<-unique(c(
  metascape_alltocontrol$MyList[which(metascape_alltocontrol$`GO:1901987 regulation of cell cycle phase`=="1.0" | metascape_alltocontrol$`GO:0051321 meiotic cell cycle`=="1.0")],
  metascape_allgenes_10mmvscontrol$MyList[which(metascape_allgenes_10mmvscontrol$`GO:0010564 regulation of cell cycle proce`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:0061982 meiosis I cell cycle process`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:1901976 regulation of cell cycle check`=="1.0")])
  )

combined_df <- select(bind_rows(
  exons_10mm = differential_pladb10mm_exons,
  exons_1mm = differential_pladb1mm_exons,
  introns_10mm = differential_pladb10mm_introns,
  introns_1mm = differential_pladb1mm_introns,
  .id = "source"  # This will be the new column indicating the origin
), -X)
cell_cycle_df<-filter(combined_df, GENE %in% cell_cycle_genes)
cell_cycle_df$protein_impact<-protein_impact$ONTO[match(cell_cycle_df$EVENT, protein_impact$EventID)]



# Prepare the summary data frame, ensuring proper sorting and factor ordering
cell_cycle_df_summary <- cell_cycle_df %>%
  # Remove duplicate rows for the same gene and event (if applicable)
  distinct(GENE, EVENT, .keep_all = TRUE) %>%
  group_by(GENE) %>%
  summarise(
    nEvents   = n(),                                        # count unique events per gene
    meanDelta = mean(abs(deltapsi), na.rm = TRUE),          # mean of absolute deltapsi
    sdDelta   = sd(abs(deltapsi), na.rm = TRUE)             # standard deviation (for reference)
  ) %>%
  # First sort by the number of events (desc), then by mean absolute deltapsi (desc)
  arrange(desc(nEvents), desc(meanDelta)) %>%
  # Set the factor levels for GENE according to the sorted order
  mutate(GENE = factor(GENE, levels = unique(GENE)))

# Update the original data frame:
# - Create a column for the absolute value of deltapsi.
# - Ensure that GENE is a factor with levels set by the summary.
# - Create a new column 'impact' that indicates whether protein_impact contains "ORF".
cell_cycle_df <- cell_cycle_df %>%
  mutate(
    absDelta = abs(deltapsi),
    GENE = factor(GENE, levels = levels(cell_cycle_df_summary$GENE)),
    impact = ifelse(grepl("ORF", protein_impact, ignore.case = TRUE), "ORF", "Non-ORF")
  )

# Create the publication-ready plot:
p <- ggplot() +
  # Bar plot showing mean absolute deltapsi per gene, colored by the number of events
  geom_bar(
    data = cell_cycle_df_summary, 
    aes(x = GENE, y = meanDelta, fill = factor(nEvents)),
    stat = "identity", 
    width = 0.7, 
    alpha = 0.8
  ) +
  # Overlay individual data points with jitter, mapping shape by the 'impact' column
  geom_jitter(
    data = cell_cycle_df,
    aes(x = GENE, y = absDelta, shape = impact),
    width = 0.15,    # small horizontal jitter to reduce overplotting
    size = 2.5, 
    alpha = 0.6,     # adjust transparency
    color = "black"  # point border color
  ) +
  # Use a pleasing color palette for the bars (from RColorBrewer)
  scale_fill_brewer(palette = "Set2", name = "Number of Events") +
  # Manually set the shapes: for example, 16 (circle) for Non-ORF and 17 (triangle) for ORF
  scale_shape_manual(values = c("Non-ORF" = 16, "ORF" = 17), name = "Protein Impact") +
  # Publication-quality theme settings
  theme_bw(base_size = 14) +
  labs(
    x = "Gene ID",
    y = "|dPSI|",
    title = "Cell Cycle related Genes"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

# Display the plot
print(p)


```


```{r cell cycle, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- cell_cycle_df$EVENT[cell_cycle_df$impact=="ORF"]
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1,show.legend = FALSE) +
  labs(
    title = "ORF Disrupted Events Cell Cycle Related",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  facet_wrap(~EVENT)
```

## Cytoskeleton related


```{r ctoskeleton genes plot}
set.seed(44)
metascape_alltocontrol <- read_excel("metascape_allgenes_alldosesvscontrol.xlsx")
metascape_allgenes_10mmvscontrol <- read_excel("metascape_allgenes_10mmvscontrol.xlsx")
metascape_allgenes_1mmvscontrol <- read_excel("metascape_allgenes_1mmvscontrol.xlsx")
metascape_allgenes_10mmvs1mm <- read_excel("metascape_allgenes_10mmvs1mm.xlsx")


cytoskeleton_genes<-unique(c(
  metascape_alltocontrol$MyList[which(metascape_alltocontrol$`GO:0034453 microtubule anchoring`=="1.0" | metascape_alltocontrol$`mmu04814 Motor proteins - Mus musculus`=="1.0")],
  metascape_allgenes_10mmvscontrol$MyList[which(metascape_allgenes_10mmvscontrol$`GO:0034453 microtubule anchoring`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:1905274 regulation of modification of`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:1902117 positive regulation of organel`=="1.0")]),
  metascape_allgenes_10mmvs1mm$MyList[which(metascape_allgenes_10mmvs1mm$`GO:0034454 microtubule anchoring at centr`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0007064 mitotic sister chromatid cohes`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0022027 interkinetic nuclear migration`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0010638 positive regulation of organel`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0034727 piecemeal microautophagy of th`=="1.0","Cep170")]
  )

combined_df <- select(bind_rows(
  exons_10mm = differential_pladb10mm_exons,
  exons_1mm = differential_pladb1mm_exons,
  introns_10mm = differential_pladb10mm_introns,
  introns_1mm = differential_pladb1mm_introns,
  .id = "source"  # This will be the new column indicating the origin
), -X)

cytoskeleton_df<-filter(combined_df, GENE %in% cytoskeleton_genes)
cytoskeleton_df$protein_impact<-protein_impact$ONTO[match(cytoskeleton_df$EVENT, protein_impact$EventID)]



# Prepare the summary data frame, ensuring proper sorting and factor ordering
cytoskeleton_df_summary <- cytoskeleton_df %>%
  # Remove duplicate rows for the same gene and event (if applicable)
  distinct(GENE, EVENT, .keep_all = TRUE) %>%
  group_by(GENE) %>%
  summarise(
    nEvents   = n(),                                        # count unique events per gene
    meanDelta = mean(abs(deltapsi), na.rm = TRUE),          # mean of absolute deltapsi
    sdDelta   = sd(abs(deltapsi), na.rm = TRUE)             # standard deviation (for reference)
  ) %>%
  # First sort by the number of events (desc), then by mean absolute deltapsi (desc)
  arrange(desc(nEvents), desc(meanDelta)) %>%
  # Set the factor levels for GENE according to the sorted order
  mutate(GENE = factor(GENE, levels = unique(GENE)))

# Update the original data frame:
# - Create a column for the absolute value of deltapsi.
# - Ensure that GENE is a factor with levels set by the summary.
# - Create a new column 'impact' that indicates whether protein_impact contains "ORF".
cytoskeleton_df <- cytoskeleton_df %>%
  mutate(
    absDelta = abs(deltapsi),
    GENE = factor(GENE, levels = levels(cytoskeleton_df_summary$GENE)),
    impact = ifelse(grepl("ORF", protein_impact, ignore.case = TRUE), "ORF", "Non-ORF")
  )

# Create the publication-ready plot:
p <- ggplot() +
  # Bar plot showing mean absolute deltapsi per gene, colored by the number of events
  geom_bar(
    data = cytoskeleton_df_summary, 
    aes(x = GENE, y = meanDelta, fill = factor(nEvents)),
    stat = "identity", 
    width = 0.7, 
    alpha = 0.8
  ) +
  # Overlay individual data points with jitter, mapping shape by the 'impact' column
  geom_jitter(
    data = cytoskeleton_df,
    aes(x = GENE, y = absDelta, shape = impact),
    width = 0.15,    # small horizontal jitter to reduce overplotting
    size = 2.5, 
    alpha = 0.6,     # adjust transparency
    color = "black"  # point border color
  ) +
  # Use a pleasing color palette for the bars (from RColorBrewer)
  scale_fill_brewer(palette = "Set2", name = "Number of Events") +
  # Manually set the shapes: for example, 16 (circle) for Non-ORF and 17 (triangle) for ORF
  scale_shape_manual(values = c("Non-ORF" = 16, "ORF" = 17), name = "Protein Impact") +
  # Publication-quality theme settings
  theme_bw(base_size = 14) +
  labs(
    x = "Gene ID",
    y = "|dPSI|",
    title = "Cytoskeleton related Genes"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

# Display the plot
print(p)


```


```{r cytoskeleton, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- cytoskeleton_df$EVENT[cytoskeleton_df$impact=="ORF"]
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1,show.legend = FALSE) +
  labs(
    title = "ORF Disrupted Events Cytoskeleton Related",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  facet_wrap(~EVENT)
```


## Chromosome related 

```{r chromsome genes plot}
set.seed(44)
metascape_alltocontrol <- read_excel("metascape_allgenes_alldosesvscontrol.xlsx")
metascape_allgenes_10mmvscontrol <- read_excel("metascape_allgenes_10mmvscontrol.xlsx")
metascape_allgenes_1mmvscontrol <- read_excel("metascape_allgenes_1mmvscontrol.xlsx")
metascape_allgenes_10mmvs1mm <- read_excel("metascape_allgenes_10mmvs1mm.xlsx")


chromosome_genes<-unique(c(
  metascape_alltocontrol$MyList[which(metascape_alltocontrol$`GO:0006974 DNA damage response`=="1.0" | metascape_alltocontrol$`GO:0051298 centrosome duplication`=="1.0" | metascape_alltocontrol$`GO:2000779 regulation of double-strand br`=="1.0")],
  metascape_allgenes_10mmvscontrol$MyList[which(metascape_allgenes_10mmvscontrol$`GO:0051298 centrosome duplication`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:0006974 DNA damage response`=="1.0" | metascape_allgenes_10mmvscontrol$`GO:0006282 regulation of DNA repair`=="1.0")],
  metascape_allgenes_10mmvs1mm$MyList[which(metascape_allgenes_10mmvs1mm$`GO:0048232 male gamete generation`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0051276 chromosome organization`=="1.0" | metascape_allgenes_10mmvs1mm$`GO:0006281 DNA repair`=="1.0")]
  ))

combined_df <- select(bind_rows(
  exons_10mm = differential_pladb10mm_exons,
  exons_1mm = differential_pladb1mm_exons,
  introns_10mm = differential_pladb10mm_introns,
  introns_1mm = differential_pladb1mm_introns,
  .id = "source"  # This will be the new column indicating the origin
), -X)

chromosome_df<-filter(combined_df, GENE %in% chromosome_genes)
chromosome_df$protein_impact<-protein_impact$ONTO[match(chromosome_df$EVENT, protein_impact$EventID)]



# Prepare the summary data frame, ensuring proper sorting and factor ordering
chromosome_df_summary <- chromosome_df %>%
  # Remove duplicate rows for the same gene and event (if applicable)
  distinct(GENE, EVENT, .keep_all = TRUE) %>%
  group_by(GENE) %>%
  summarise(
    nEvents   = n(),                                        # count unique events per gene
    meanDelta = mean(abs(deltapsi), na.rm = TRUE),          # mean of absolute deltapsi
    sdDelta   = sd(abs(deltapsi), na.rm = TRUE)             # standard deviation (for reference)
  ) %>%
  # First sort by the number of events (desc), then by mean absolute deltapsi (desc)
  arrange(desc(nEvents), desc(meanDelta)) %>%
  # Set the factor levels for GENE according to the sorted order
  mutate(GENE = factor(GENE, levels = unique(GENE)))

# Update the original data frame:
# - Create a column for the absolute value of deltapsi.
# - Ensure that GENE is a factor with levels set by the summary.
# - Create a new column 'impact' that indicates whether protein_impact contains "ORF".
chromosome_df <- chromosome_df %>%
  mutate(
    absDelta = abs(deltapsi),
    GENE = factor(GENE, levels = levels(chromosome_df_summary$GENE)),
    impact = ifelse(grepl("ORF", protein_impact, ignore.case = TRUE), "ORF", "Non-ORF")
  )

# Create the publication-ready plot:
p <- ggplot() +
  # Bar plot showing mean absolute deltapsi per gene, colored by the number of events
  geom_bar(
    data = chromosome_df_summary, 
    aes(x = GENE, y = meanDelta, fill = factor(nEvents)),
    stat = "identity", 
    width = 0.7, 
    alpha = 0.8
  ) +
  # Overlay individual data points with jitter, mapping shape by the 'impact' column
  geom_jitter(
    data = chromosome_df,
    aes(x = GENE, y = absDelta, shape = impact),
    width = 0.15,    # small horizontal jitter to reduce overplotting
    size = 2.5, 
    alpha = 0.6,     # adjust transparency
    color = "black"  # point border color
  ) +
  # Use a pleasing color palette for the bars (from RColorBrewer)
  scale_fill_brewer(palette = "Set2", name = "Number of Events") +
  # Manually set the shapes: for example, 16 (circle) for Non-ORF and 17 (triangle) for ORF
  scale_shape_manual(values = c("Non-ORF" = 16, "ORF" = 17), name = "Protein Impact") +
  # Publication-quality theme settings
  theme_bw(base_size = 14) +
  labs(
    x = "Gene ID",
    y = "|dPSI|",
    title = "Chromosome related Genes"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

# Display the plot
print(p)


```

```{r chromosome, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- chromosome_df$EVENT[chromosome_df$impact=="ORF"]
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1,show.legend = FALSE) +
  labs(
    title = "ORF Disrupted Events Chromosome Related",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  facet_wrap(~EVENT)
```


## Spliceosome related 

```{r spliceosome genes plot}
set.seed(44)
metascape_alltocontrol <- read_excel("metascape_allgenes_alldosesvscontrol.xlsx")
metascape_allgenes_10mmvscontrol <- read_excel("metascape_allgenes_10mmvscontrol.xlsx")
metascape_allgenes_1mmvscontrol <- read_excel("metascape_allgenes_1mmvscontrol.xlsx")
metascape_allgenes_10mmvs1mm <- read_excel("metascape_allgenes_10mmvs1mm.xlsx")


splicesome_genes<-unique(c(
  metascape_alltocontrol$MyList[which(metascape_alltocontrol$`GO:0000245 spliceosomal complex assembly`=="1.0")],
  metascape_allgenes_10mmvscontrol$MyList[which(metascape_allgenes_10mmvscontrol$`GO:0000245 spliceosomal complex assembly`=="1.0")],
  metascape_allgenes_1mmvscontrol$MyList[which(metascape_allgenes_1mmvscontrol$`GO:0000245 spliceosomal complex assembly`=="1.0")]
  ))

combined_df <- select(bind_rows(
  exons_10mm = differential_pladb10mm_exons,
  exons_1mm = differential_pladb1mm_exons,
  introns_10mm = differential_pladb10mm_introns,
  introns_1mm = differential_pladb1mm_introns,
  .id = "source"  # This will be the new column indicating the origin
), -X)

spliceosome_df<-filter(combined_df, GENE %in% splicesome_genes)
spliceosome_df$protein_impact<-protein_impact$ONTO[match(spliceosome_df$EVENT, protein_impact$EventID)]



# Prepare the summary data frame, ensuring proper sorting and factor ordering
spliceosome_df_summary <- spliceosome_df %>%
  # Remove duplicate rows for the same gene and event (if applicable)
  distinct(GENE, EVENT, .keep_all = TRUE) %>%
  group_by(GENE) %>%
  summarise(
    nEvents   = n(),                                        # count unique events per gene
    meanDelta = mean(abs(deltapsi), na.rm = TRUE),          # mean of absolute deltapsi
    sdDelta   = sd(abs(deltapsi), na.rm = TRUE)             # standard deviation (for reference)
  ) %>%
  # First sort by the number of events (desc), then by mean absolute deltapsi (desc)
  arrange(desc(nEvents), desc(meanDelta)) %>%
  # Set the factor levels for GENE according to the sorted order
  mutate(GENE = factor(GENE, levels = unique(GENE)))

# Update the original data frame:
# - Create a column for the absolute value of deltapsi.
# - Ensure that GENE is a factor with levels set by the summary.
# - Create a new column 'impact' that indicates whether protein_impact contains "ORF".
spliceosome_df <- spliceosome_df %>%
  mutate(
    absDelta = abs(deltapsi),
    GENE = factor(GENE, levels = levels(spliceosome_df_summary$GENE)),
    impact = ifelse(grepl("ORF", protein_impact, ignore.case = TRUE), "ORF", "Non-ORF")
  )

# Create the publication-ready plot:
p <- ggplot() +
  # Bar plot showing mean absolute deltapsi per gene, colored by the number of events
  geom_bar(
    data = spliceosome_df_summary, 
    aes(x = GENE, y = meanDelta, fill = factor(nEvents)),
    stat = "identity", 
    width = 0.7, 
    alpha = 0.8
  ) +
  # Overlay individual data points with jitter, mapping shape by the 'impact' column
  geom_jitter(
    data = spliceosome_df,
    aes(x = GENE, y = absDelta, shape = impact),
    width = 0.15,    # small horizontal jitter to reduce overplotting
    size = 2.5, 
    alpha = 0.6,     # adjust transparency
    color = "black"  # point border color
  ) +
  # Use a pleasing color palette for the bars (from RColorBrewer)
  scale_fill_brewer(palette = "Set2", name = "Number of Events") +
  # Manually set the shapes: for example, 16 (circle) for Non-ORF and 17 (triangle) for ORF
  scale_shape_manual(values = c("Non-ORF" = 16, "ORF" = 17), name = "Protein Impact") +
  # Publication-quality theme settings
  theme_bw(base_size = 14) +
  labs(
    x = "Gene ID",
    y = "|dPSI|",
    title = "Spliceosome related Genes"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

# Display the plot
print(p)


```

```{r spliceosome, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- spliceosome_df$EVENT[spliceosome_df$impact=="ORF"]
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1,show.legend = FALSE) +
  labs(
    title = "ORF Disrupted Events Spliceosome Related",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  facet_wrap(~EVENT)
```


## Table

The *source* columns refers to whether it has been found differentially spliced in the 10mM vs control, or 1mM vs control.

```{r cell cycle df}

combined_df$protein_impact<-protein_impact$ONTO[match(combined_df$EVENT, protein_impact$EventID)]

datatable(
  combined_df,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# System Settings

```{r session info}
sessionInfo()
```


