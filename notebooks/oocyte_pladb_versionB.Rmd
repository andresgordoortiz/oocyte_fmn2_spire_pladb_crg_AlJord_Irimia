---
title: 'Oocyte Alternative Splicing Analysis'
Subtitle: "Pladienolide B"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    code_folding: hide
    code_download: false
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options:
  markdown:
    wrap: 72


header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        #logos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #logos img {
            height: 80px;
            margin: 0 15px;
        }
     </style>'
---



```{css, echo=FALSE}
/* Minimal and clean custom CSS */
body {
  font-family: 'Roboto', sans-serif;
  color: #333; /* Neutral dark gray for body text */
  background-color: #f9f9f9; /* Light background */
  margin: 0;
  padding: 0;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto', sans-serif;
  font-weight: bold;
}

/* Header Colors */
h1 {
  font-size: 2.5em;
  color: #5E14C4; /* Main headers in purple */
}

h2 {
  font-size: 2em;
  color: #4A10A1; /* Darker purple for secondary headers */
}

h3 {
  font-size: 1.75em;
  color: #3B0D7E; /* Even darker purple for tertiary headers */
}

p {
  text-align: justify;
  line-height: 1.6;
  margin: 0 0 1em;
}

/* Styling for subtitle, authors, and date */
.subtitle, .author, .date {
  color: #5E14C4;
  font-size: 1.25em;
  text-align: center;
  margin-bottom: 0.5em;
}

/* Link styling */
a {
  color: #5E14C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Table styling */
table {
  border-collapse: collapse;
  width: 100%;
  margin: 20px 0;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 10px;
}

table th {
  background-color: #5E14C4;
  color: white;
}

table tr:nth-child(even) {
  background-color: #f9f9f9;
}

table tr:hover {
  background-color: #f1f1f1;
}

```



```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)


# Load required libraries
library("betAS")
library("ggplot2")
library("plotly")
library("dplyr")
library("tidyverse")
library("cowplot")
library("DT")
library("paletteer")
library("ggupset")
library("showtext")
library("ggtext")
library("readxl")
library("biomaRt")
library("enrichR")
library("patchwork")
library("org.Mm.eg.db")
library("org.Hs.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ComplexHeatmap")
library("enrichR")
library("colorRamp2")
library("dendextend")
# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"


```

# Introduction to this Analysis


## Part 1: Upstream Analysis

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**:
  - Downloading `*.fastq.gz` files from 3 different studies:
    - **Pladienolide B (PladB) treated Oocytes**
  - Merging technical replicates for superior sequencing depth

2. **Alignment**:
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## Part 2: Statistical Analysis

### Objective
To identify splicing events that are differentially spliced in Oocytes treated with PladB with two differentes doses.

### Steps

1. **Statistical Testing**:
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform Beta Distribution simulations, T-test and ANOVA to obtain:
     - **False Discovery Rate (FDR)**
     - **F-statistic**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.1**
     - **Pdiff ≥ 0.90**

3. **Batch Effect Mitigation**:
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation. All exon related events (C1,C2,C3,S,including microexons) will be collapsed into a single list, EX.

---

## Importing Inclusion Data

```{r inclusion tables}
pladb_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/pladb_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
pladb_events <- getEvents(pladb_data, tool = "vast-tools") # Extract alternative splicing events
pladb_exons <- filterEvents(pladb_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
pladb_alt <- filterEvents(pladb_events, types = c("Alt5", "Alt3"), N = 2)
pladb_introns <- filterEvents(pladb_events, types = c("IR"), N = 2)
```


## Metadata { .tabset}

### PladB

```{r metadata pladb}
# Load metadata file containing sample information
metadata_pladb <- read.csv(paste0(getwd(),"/metadata/metadata_pladb.csv"), sep = "\t")
metadata_pladb<-metadata_pladb[seq(1, nrow(metadata_pladb), by = 2),]
DT::datatable(metadata_pladb, options = list(pageLength = nrow(metadata_pladb), scrollX = TRUE))
```


---

# Total Splicing Events


```{r splicing events barplot stacked}

# Adjusted version of the script
splicing_events <- tibble(
  event_type = names(pladb_events$EventsPerType),
  pladb = pladb_events$EventsPerType
)

splicing_events_long <- splicing_events %>%
  pivot_longer(cols = c(pladb),
               names_to = "study", values_to = "count") %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

# Proportion bar plot
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) +
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "<b style='font-size:18px;'>Proportion of Splicing Events by Study</b>",
    x = NULL,
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal(base_family = font) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_markdown(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5)
  ) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

splicing_events_long_sum<-splicing_events_long %>%
  dplyr::group_by(study) %>%
  summarize(count = sum(count))


# Absolute counts plot
plot_absolute <- ggplot(splicing_events_long_sum, aes(y = count, x = study)) +
  geom_point(color = "#C70039", size = 3) +
  geom_text(aes(label = count), vjust = -1, size = 4, check_overlap = TRUE) +
  labs(
    x = "Study",
    y = "Number of Events",
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text( size=15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2)))


# Combine plots
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.5)) &
  theme(plot.margin = margin(5,5, 0, 5))

# Display combined plot
combined_plot
```

# Splicing & Sample Quality Checking

Splicing inclusion plots look like a ***U*** when looking at the *exons*, as normally most of them are spliced out completely (PSI=0) or constitutively spliced in (PSI=1), but some of them are in between (alternatively spliced). Those are the most interesting for the analysis. On the other hand, *introns* are usually not included (that is their definition), but in a few cases they are included. Thus, the intron plot looks like the exponential distribution.

## PladB 10mm vs Control PSI Plot 

This is used to check if there is higher intron retention after pladb treatment. The plot shows the PSI of PladB 10mM vs the Control.

```{r intron retention checking}
pladb_exons$PSI %>%
  filter(!is.na(EVENT)) %>%
  select(EVENT, contains("X2022")) %>%
  pivot_longer(-EVENT, names_to = "sample", values_to = "PSI") %>%
  mutate(grp = ifelse(grepl("38|39|40", sample, perl = TRUE), "CTR",
                      ifelse(grepl("41|42|43", sample, perl = TRUE), "mm1", "PladB10mM"))) %>%
  group_by(grp, EVENT) %>%
  reframe(mPSI = mean(PSI)) %>%
  pivot_wider(id_cols = "EVENT", names_from = "grp", values_from = "mPSI") %>%
  filter(PladB10mM != 0 & CTR != 0) %>%
  ggplot(aes(x = CTR, y = PladB10mM)) +
  geom_point(aes(color = ifelse(PladB10mM > CTR, "above", "below")), size = 0.5) +
  scale_color_manual(values = c("above" = "lightcoral", "below" = "lightblue")) +
  labs(color = "Position") +
  theme_minimal()

```




## Does the number of exons of a gene affect Inclusion? { .tabset}

First I classified the genes according to the number of exons they contain from VASTDB. Then I plotted the dPSI of all exons grouped by that classification.

### Exons 


```{r inclusionumber of exons pladb}
pladb_exons_df<-na.omit(pladb_exons$PSI)
pladb_exons_df$exon_group<-vastdb_exons$exon_group[match(pladb_exons_df$EVENT,vastdb_exons$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_10mm <- rowMeans(df[, 13:15])
  avg_control <- rowMeans(df[, 7:9])
  avg_10mm - avg_control
}

# Compute the difference and group by exon groups
pladb_exons_df$difference <- compute_difference(pladb_exons_df)

pladb_exons_df$exon_group<-factor(pladb_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))

# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  na.omit(pladb_exons_df[abs(pladb_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "PladB, dPSI = 10mm - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```

## Introns

```{r inclusionumber of introns pladb}
pladb_introns_df<-na.omit(pladb_introns$PSI)
pladb_introns_df$intron_group<-vastdb_introns$intron_group[match(pladb_introns_df$EVENT,vastdb_introns$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 10:12])
  avg_control <- rowMeans(df[, 7:9])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
pladb_introns_df$difference <- compute_difference(pladb_introns_df)


# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  na.omit(pladb_introns_df[abs(pladb_introns_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 100, position = "identity") +
  facet_wrap(~intron_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "Spire, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```



## PCA Plot { .tabset}

### PladB

```{r pca calculation}
# Subset and scale data
pca_pladb <- pladb_data[, c("EVENT",pladb_events$Samples)] %>%
  na.omit()

rownames(pca_pladb)<- pca_pladb$EVENT
pca_pladb<-t(pca_pladb[,-1])


pca_result_pladb <- prcomp(pca_pladb)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result_pladb$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-metadata_pladb$Description
```

```{r pca plotting}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), )) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result_pladb)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result_pladb)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  coord_fixed()

pca_plot

```


# Differential Splicing Calculation

```{r aux_featuregroup}
# Extract unique groups and sample IDs
# pladb

groupingVariable <- "Description"


groups_pladb <- unique(metadata_pladb[, groupingVariable])
samples_pladb <- metadata_pladb$fastq_files
samples_pladb <- paste0(
  "X",
  sub("\\.fastq\\.gz$", "", samples_pladb),
  "_merged"
)


random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")

# Create group list with metadata
groupList_pladb <- lapply(1:length(groups_pladb), function(i) {
  list(
    name = groups_pladb[i],
    samples = samples_pladb[metadata_pladb[, groupingVariable] == groups_pladb[i]],
    color = random_colors[i]
  )
})
names(groupList_pladb) <- groups_pladb

```

```{r groups_auxiliary}
# Define groups
groupA_pladb    <- "ControlFmn2+-"
groupC_pladb    <- "Fmn2+-_+1mMPlatB"
groupB_pladb <- "Fmn2+-_+10mMPlatB"

# Define samples inside each group
samplesA_pladb    <- groupList_pladb[[groupA_pladb]]$samples
samplesB_pladb    <- groupList_pladb[[groupB_pladb]]$samples
samplesC_pladb    <- groupList_pladb[[groupC_pladb]]$samples
colsGroupA_pladb    <- convertCols(pladb_exons$PSI, samplesA_pladb)
colsGroupB_pladb   <- convertCols(pladb_exons$PSI, samplesB_pladb)
colsGroupC_pladb   <- convertCols(pladb_exons$PSI, samplesC_pladb)

```

## Exon Lists

### Calculations

```{r pdiff calculation exons}
pladb_pdiff_exons <- prepareTableVolcano(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupB_pladb,
  labA = groupA_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_control_pdiff_exons <- prepareTableVolcano(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupC_pladb,
  labA = groupA_pladb,
  labB = groupC_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_10mm_pdiff_exons <- prepareTableVolcano(
  psitable = pladb_exons$PSI,
  qualtable = pladb_exons$Qual,
  npoints = 500,
  colsA = colsGroupC_pladb,
  colsB = colsGroupB_pladb,
  labA = groupC_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)


```




### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.

#### PladB 10mM vs Control

```{r pladb fdr volcano exons 10mm control}
# INtersecting dhared exons between 10mm vs control and 1mm vs control
differential_pladb10mm_exons<-na.omit(pladb_pdiff_exons[pladb_pdiff_exons$Pdiff >= 0.90 & abs(pladb_pdiff_exons$deltapsi) >= 0.1,])
differential_pladb1mm_exons<-na.omit(pladb_1mm_control_pdiff_exons[pladb_1mm_control_pdiff_exons$Pdiff >= 0.90 & abs(pladb_1mm_control_pdiff_exons$deltapsi) >= 0.1,])
differential_pladb10mm_1mm_exons<-na.omit(pladb_1mm_10mm_pdiff_exons[pladb_1mm_10mm_pdiff_exons$Pdiff >= 0.90 & abs(pladb_1mm_10mm_pdiff_exons$deltapsi) >= 0.1,])

shared_exons<-differential_pladb10mm_exons$EVENT[differential_pladb10mm_exons$EVENT %in% differential_pladb1mm_exons$EVENT]

# Volcano plot
library(ggrepel)
pladb_pdiff_exons<-na.omit(pladb_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_pdiff_exons$Shared <- ifelse(pladb_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_pdiff_exons$Significant <- ifelse(
  pladb_pdiff_exons$Pdiff >= 0.90 & pladb_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_pdiff_exons$Pdiff >= 0.90 & pladb_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_pdiff_exons$negLogpvalue <- -log10(1 - pladb_pdiff_exons$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (10mm - control) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```

#### PladB 1mM vs Control

```{r pladb fdr volcano exons 1mm control}
pladb_1mm_control_pdiff_exons<-na.omit(pladb_1mm_control_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_1mm_control_pdiff_exons$Shared <- ifelse(pladb_1mm_control_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_1mm_control_pdiff_exons$Significant <- ifelse(
  pladb_1mm_control_pdiff_exons$Pdiff >= 0.90 & pladb_1mm_control_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_control_pdiff_exons$Pdiff >= 0.90 & pladb_1mm_control_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_control_pdiff_exons$negLogpvalue <- -log10(1 - pladb_1mm_control_pdiff_exons$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_1mm_control_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (1mm - Control) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```

#### PladB 10mM vs 1mM

```{r pladb fdr volcano exons 10mm 1mm}
pladb_1mm_10mm_pdiff_exons<-na.omit(pladb_1mm_10mm_pdiff_exons)
# Add a Shared column based on the shared_exons
pladb_1mm_10mm_pdiff_exons$Shared <- ifelse(pladb_1mm_10mm_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
pladb_1mm_10mm_pdiff_exons$Significant <- ifelse(
  pladb_1mm_10mm_pdiff_exons$Pdiff >= 0.90 & pladb_1mm_10mm_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_10mm_pdiff_exons$Pdiff >= 0.90 & pladb_1mm_10mm_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_10mm_pdiff_exons$negLogpvalue <- -log10(1 - pladb_1mm_10mm_pdiff_exons$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_1mm_10mm_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (10mm - 1mm) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```

#### Dynamics of Shared Exons

```{r dynamics shraed exons}
shared_exons_df <- data.frame(
  Event = shared_exons,
  control = rep(0, length(shared_exons)),
  PladB_1mm = 0 + pladb_1mm_control_pdiff_exons$deltapsi[pladb_1mm_control_pdiff_exons$EVENT %in% shared_exons]
)
shared_exons_df$PladB_10mm <- shared_exons_df$PladB_1mm + pladb_1mm_10mm_pdiff_exons$deltapsi[pladb_1mm_10mm_pdiff_exons$EVENT %in% shared_exons]
shared_exons_df <- pivot_longer(shared_exons_df, cols = 2:4, names_to = "dose")
shared_exons_df$dose <- factor(shared_exons_df$dose, levels = c("control", "PladB_1mm", "PladB_10mm"))

# Plot
dose_dependent_plot<-ggplot(shared_exons_df, aes(x = dose, y = value, group = Event, color = Event)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # Horizontal line at y=0
  geom_line(size = 1, alpha = 0.7) + # Connect points with lines
  geom_point(size = 3, alpha = 0.8) + # Points for emphasis
  facet_wrap(~ Event, scales = "fixed") + # Facet by Event
  labs(
    title = "Dose-Dependent Changes in Exons deltaPSI",
    x = "Dose",
    y = "ΔPSI",
    color = "Event"
  ) +
  theme_minimal(base_size = 15) + # Clean, professional theme
  theme(
    strip.text = element_text(face = "bold"), # Highlight Event labels
    legend.position = "none", # Remove legend for clarity in facets
    axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels
  )


dose_dependent_plot
```

### Individual Combination Tables { .tabset}

These tables show the exons that show a FDR<=`r FDR` and Pdiff (1-pvalue)>=`r pdiff` in the pairwise comparison of each condition.

#### PladB 10mM vs control


```{r pladb combination table exons 10mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```

#### PladB 1mM vs Control

```{r pladb combination table exons 1mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb1mm_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### PladB 10mM vs 1mM

```{r pladb combination table exons 10mm 1mm}
# Render DataTable with enhancements
datatable(
  pladb_10mm_1mm_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


#### Shared Exons in 10mM vs control & 1mM vs control

```{r pladb combination table exons shared}
shared_exons_datatable<-pladb_pdiff_exons[pladb_pdiff_exons$EVENT %in% shared_exons,]
# Render DataTable with enhancements
datatable(
  shared_exons_datatable,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

## Intron Lists

### Calculations

```{r pdiff calculation introns}
pladb_pdiff_introns <- prepareTableVolcano(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupB_pladb,
  labA = groupA_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_control_pdiff_introns <- prepareTableVolcano(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_pladb,
  colsB = colsGroupC_pladb,
  labA = groupA_pladb,
  labB = groupC_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)

pladb_1mm_10mm_pdiff_introns <- prepareTableVolcano(
  psitable = pladb_introns$PSI,
  qualtable = pladb_introns$Qual,
  npoints = 500,
  colsA = colsGroupC_pladb,
  colsB = colsGroupB_pladb,
  labA = groupC_pladb,
  labB = groupB_pladb,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed=TRUE,
  CoverageWeight = FALSE)


```


### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.

#### PladB 10mM vs Control

```{r pladb fdr volcano introns 10mm control}
# INtersecting dhared introns between 10mm vs control and 1mm vs control
differential_pladb10mm_introns<-na.omit(pladb_pdiff_introns[pladb_pdiff_introns$Pdiff >= 0.90 & abs(pladb_pdiff_introns$deltapsi) >= 0.1,])
differential_pladb1mm_introns<-na.omit(pladb_1mm_control_pdiff_introns[pladb_1mm_control_pdiff_introns$Pdiff >= 0.90 & abs(pladb_1mm_control_pdiff_introns$deltapsi) >= 0.1,])

differential_pladb10mm_1mm_introns<-na.omit(pladb_1mm_10mm_pdiff_introns[pladb_1mm_10mm_pdiff_introns$Pdiff >= 0.90 & abs(pladb_1mm_10mm_pdiff_introns$deltapsi) >= 0.1,])

shared_introns<-differential_pladb10mm_introns$EVENT[differential_pladb10mm_introns$EVENT %in% differential_pladb1mm_introns$EVENT]

# Volcano plot
library(ggrepel)
pladb_pdiff_introns<-na.omit(pladb_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_pdiff_introns$Shared <- ifelse(pladb_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_pdiff_introns$Significant <- ifelse(
  pladb_pdiff_introns$Pdiff >= 0.90 & pladb_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_pdiff_introns$Pdiff >= 0.90 & pladb_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_pdiff_introns$negLogpvalue <- -log10(1 - pladb_pdiff_introns$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (10mm - control) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```

#### PladB 1mM vs Control

```{r pladb fdr volcano introns 1mm control}
pladb_1mm_control_pdiff_introns<-na.omit(pladb_1mm_control_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_1mm_control_pdiff_introns$Shared <- ifelse(pladb_1mm_control_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_1mm_control_pdiff_introns$Significant <- ifelse(
  pladb_1mm_control_pdiff_introns$Pdiff >= 0.90 & pladb_1mm_control_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_control_pdiff_introns$Pdiff >= 0.90 & pladb_1mm_control_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_control_pdiff_introns$negLogpvalue <- -log10(1 - pladb_1mm_control_pdiff_introns$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_1mm_control_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (1mm - Control) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```

#### PladB 10mM vs 1mM

```{r pladb fdr volcano introns 10mm 1mm}
pladb_1mm_10mm_pdiff_introns<-na.omit(pladb_1mm_10mm_pdiff_introns)
# Add a Shared column based on the shared_introns
pladb_1mm_10mm_pdiff_introns$Shared <- ifelse(pladb_1mm_10mm_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
pladb_1mm_10mm_pdiff_introns$Significant <- ifelse(
  pladb_1mm_10mm_pdiff_introns$Pdiff >= 0.90 & pladb_1mm_10mm_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    pladb_1mm_10mm_pdiff_introns$Pdiff >= 0.90 & pladb_1mm_10mm_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
pladb_1mm_10mm_pdiff_introns$negLogpvalue <- -log10(1 - pladb_1mm_10mm_pdiff_introns$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(pladb_1mm_10mm_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "Pladb (10mm - 1mm) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot

```


#### Dynamics of Shared Introns

```{r dynamics shraed introns}
shared_introns_df <- data.frame(
  Event = shared_introns,
  control = rep(0, length(shared_introns)),
  PladB_1mm = 0 + pladb_1mm_control_pdiff_introns$deltapsi[pladb_1mm_control_pdiff_introns$EVENT %in% shared_introns]
)
shared_introns_df$PladB_10mm <- shared_introns_df$PladB_1mm + pladb_1mm_10mm_pdiff_introns$deltapsi[pladb_1mm_10mm_pdiff_introns$EVENT %in% shared_introns]
shared_introns_df <- pivot_longer(shared_introns_df, cols = 2:4, names_to = "dose")
shared_introns_df$dose <- factor(shared_introns_df$dose, levels = c("control", "PladB_1mm", "PladB_10mm"))

# Plot
dose_dependent_plot<-ggplot(shared_introns_df, aes(x = dose, y = value, group = Event, color = Event)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # Horizontal line at y=0
  geom_line(size = 1, alpha = 0.7) + # Connect points with lines
  geom_point(size = 3, alpha = 0.8) + # Points for emphasis
  facet_wrap(~ Event, scales = "fixed") + # Facet by Event
  labs(
    title = "Dose-Dependent Changes in Introns deltaPSI",
    x = "Dose",
    y = "ΔPSI",
    color = "Event"
  ) +
  theme_minimal(base_size = 15) + # Clean, professional theme
  theme(
    strip.text = element_text(face = "bold"), # Highlight Event labels
    legend.position = "none", # Remove legend for clarity in facets
    axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels
  )


dose_dependent_plot
```




### Individual Combination Tables { .tabset}

These tables show the introns that show a FDR<=`r FDR` and PDiff (1-pvalue)>=`r pdiff` in the pairwise comparison of each condition.

#### PladB 10mM vs control


```{r pladb combination table introns 10mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```

#### PladB 1mM vs Control


```{r pladb combination table introns 1mm control}
# Render DataTable with enhancements
datatable(
  differential_pladb1mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### PladB 10mM vs 1mM


```{r pladb combination table introns 10mm 1mm}
# Render DataTable with enhancements
datatable(
  differential_pladb10mm_1mm_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


#### Shared Introns in 10mM vs control & 1mM vs control

```{r pladb combination table introns shared}
# Render DataTable with enhancements
shared_introns_datatable<-pladb_pdiff_introns[pladb_pdiff_introns$EVENT %in% shared_introns,]
datatable(
  shared_introns_datatable,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```




## PSI Distribution Plots { .tabset}

These plots aim to explore any enrichment of either (intron/exon) retention or (intron/exon) exclusion. Symmetric plots show that inclusion and retention are equally common between conditions. Only showing events with |dPSI|>=0.1 for higher clarity. 

### PladB

```{r splicing distribution plot, fig.width=10}

# List of dataframes with metadata
dfs <- list(
  list(df = pladb_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_exons, group = "Exons", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_exons, group = "Exons", study = "PladB_10mM_vs_1mm"),
  list(df = pladb_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_Control"),
  list(df = pladb_1mm_control_pdiff_introns, group = "Introns", study = "PladB_1mM_vs_Control"),
  list(df = pladb_1mm_10mm_pdiff_introns, group = "Introns", study = "PladB_10mM_vs_1mm")
)

# Add metadata columns to each dataframe beforehand
dfs_with_metadata <- lapply(dfs, function(x) {
  x$df %>%
    mutate(Group = x$group, Study = x$study)
})

# Combine all dataframes into one using bind_rows() for faster merging
final_df <- bind_rows(dfs_with_metadata) %>%
  select(EVENT, Group, Study, deltapsi) %>%
  filter(abs(deltapsi)>=0.1) %>%
  na.omit()# Adjust this line if other columns should be prioritized


plot_psi_distribution <- ggplot(final_df, aes(y=..density..,x = deltapsi, fill = ifelse(deltapsi < 0, "Skipped", "Included"))) +
  geom_histogram( bins = 100, position = "identity") +
  labs(
    title = "PSI Distribution in PladB treated samples",
    x = "ΔPSI",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~Group*Study,scales = "fixed")

plot_psi_distribution
```


## Enrichment Analysis with EnrichR { .tabset}

### Gene Ontology of all genes differentially spliced under any dose compared to control.

```{r pladb enrichr}
enrichdata<-enrichr(unique(c(differential_pladb10mm_exons$GENE,differential_pladb1mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_introns$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))
```

#### GO Biological Process

```{r pladb bioprocess, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
```

#### GO Cellular Component

```{r pladb cellcomponent, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
```

#### GO Molecular Function

```{r pladb molfunction, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
```

### PladB 10mM vs 1mM { .tabset}

```{r pladb enrichr 10mm 1mm}
enrichdata<-enrichr(unique(c(differential_pladb10mm_1mm_introns$GENE, differential_pladb10mm_1mm_exons$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))
```

#### GO Biological Process

```{r pladb bioprocess 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[1]])
```

#### GO Cellular Component

```{r pladb cellcomponent 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[2]])
```

#### GO Molecular Function

```{r pladb molfunction 10mm 1mm, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[3]])
```

# Nuclear Speckle Protein Splicing Correlation

Nuclear speckles genes were obtained from the Human Protein Atlas
Differentially spliced events were filtered to obtain those proteins localizing within speckles. I performed pearson correlation between those selected events.

```{r nuclear spckeles data hadnling spire}
set.seed(43)
speckles_proteins <- read_tsv("nuclear_speckles_protein_human_atlas.tsv")

# Filter events based on gene names
pladb_speckle_prots <- pladb_events$PSI %>%
  filter(
    EVENT %in% differential_pladb10mm_exons$EVENT[
      tolower(differential_pladb10mm_exons$GENE) %in% tolower(speckles_proteins$Gene)
    ] |
    EVENT %in% differential_pladb10mm_introns$EVENT[
      tolower(differential_pladb10mm_introns$GENE) %in% tolower(speckles_proteins$Gene)
    ] |
    EVENT %in% differential_pladb1mm_introns$EVENT[
      tolower(differential_pladb1mm_introns$GENE) %in% tolower(speckles_proteins$Gene)
    ] |
    EVENT %in% differential_pladb1mm_exons$EVENT[
      tolower(differential_pladb1mm_exons$GENE) %in% tolower(speckles_proteins$Gene)
    ]
  )

# Create a mapping between events and gene names
event_gene_map <- unique(dplyr::bind_rows(
  select(differential_pladb10mm_exons, EVENT, GENE),
  select(differential_pladb10mm_introns, EVENT, GENE),
  select(differential_pladb1mm_introns, EVENT, GENE),
  select(differential_pladb1mm_exons, EVENT, GENE)
))

# Merge to associate genes with the selected events
pladb_speckle_prots <- pladb_speckle_prots %>%
  left_join(event_gene_map, by = "EVENT")

# Update row names to include gene labels
rownames(pladb_speckle_prots) <- paste(pladb_speckle_prots$EVENT, pladb_speckle_prots$GENE.x, sep = " | ")

# Transpose the filtered matrix for correlation calculation
pladb_speckle_prots_t <- t(pladb_speckle_prots[, 7:15])

# Calculate correlation matrix
cor_matrix <- cor(pladb_speckle_prots_t)

# Create a heatmap with rotated x-axis labels
heatmap <- Heatmap(cor_matrix,
                   name = "Correlation",
                   clustering_distance_rows = "pearson",  # Row clustering method
                   clustering_method_rows = "complete",     # Clustering method for rows
                   show_row_dend = TRUE,                    # Show row dendrogram
                   show_column_dend = TRUE,                 # Show column dendrogram
                   column_title = "Correlation Heatmap",    # Title for the heatmap
                   row_title = "Variables",                 # Title for rows
                   column_title_gp = gpar(fontsize = 14),   # Title formatting
                   row_title_gp = gpar(fontsize = 14),      # Row title formatting
                   column_names_rot = 45                    # Rotate column labels by 45 degrees
)

# Draw the heatmap
draw(heatmap)

```

```{r table speckles pladb}
# Render DataTable with enhancements
datatable(
  pladb_speckle_prots              # Enable export buttons
)
```

# Splicing Dynamics Heatmap PladB

```{r heatmap prep 2, results='hide', fig.show='hide'}
set.seed(44)

# Extract all events
pladb_all <- filterEvents(
  pladb_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR","Alt3","Alt5"),
  N = 3
)

# Convert PSI values to a matrix and set row names
pladb_matrix <- pladb_all$PSI[, 7:15] %>%
  as.matrix()
rownames(pladb_matrix) <- pladb_all$PSI$EVENT

# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb10mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns))
pladb_matrix <- pladb_matrix[rownames(pladb_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
colnames(pladb_matrix)<-metadata_pladb$fastq_files
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(pladb_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 3) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(pladb_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-5


reference_table<-data.frame(EVENT=c(differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb10mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns$EVENT), GENE=c(differential_pladb10mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb10mm_exons$GENE,differential_pladb1mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb1mm_introns$GENE))



ht<-Heatmap(
  pladb_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes PladB Samples at Different concentrations of PladB",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(pladb_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(pladb_matrix)

final_impact <- protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact)) %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))


# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot 2, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  pladb_matrix,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 30))
  })
}


```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final 2}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- pladb_matrix[row_order, col_order]

final_impact_string<-protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-dplyr::select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))



```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

orf_comparingcontrol_events<-unique(reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]])
```

#### GO Biological Process

```{r orf bioprocess fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# Event Densities { .tabset}

## ORF Disrupted Events on GO: Cilium movement involved in cell motility

```{r densities_per_event, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- c("MmuINT0050724", "MmuEX0027064", "MmuEX0001718", 
          "MmuINT1008824", "MmuINT0051012", "MmuINT0087636", 
          "MmuEX0032332", "MmuEX0032352", "MmuEX0025964", 
          "MmuINT1008798", "MmuINT0029238","MmuEX0010927","MmuINT0060968")
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1) +
  labs(
    title = "ORF Disrupted Events on GO: Cilium movement involved in cell motility",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  ) + 
  facet_wrap(~EVENT)
```

## ORF Disrupted Events on GO: Regulation of fibroblast proliferation

```{r densities_per_event 2, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- c("MmuEX0019420", "MmuEX0019425", "MmuEX0016754", 
          "MmuEX0010581", "MmuINT0016328", "MmuINT0078365")
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1) +
  labs(
    title = "ORF Disrupted Events on GO: Regulation of fibroblast proliferation",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  ) + 
  facet_wrap(~EVENT)
```

# PladB 10mM vs Control UNIQUE (not shared with 1mM) events

```{r heatmap prep, results='hide', fig.show='hide'}
set.seed(44)


# Convert PSI values to a matrix and set row names
pladb_matrix <- pladb_all$PSI[, 7:15] %>%
  as.matrix()
rownames(pladb_matrix) <- pladb_all$PSI$EVENT


# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_pladb10mm_exons[!differential_pladb10mm_exons$EVENT %in% shared_exons,]$EVENT, differential_pladb10mm_introns[!differential_pladb10mm_introns$EVENT %in% shared_introns,]$EVENT))
pladb_matrix <- pladb_matrix[rownames(pladb_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
colnames(pladb_matrix)<-metadata_pladb$fastq_files
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(pladb_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 3) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(pladb_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-5


reference_table<-data.frame(EVENT=c(differential_pladb10mm_exons$EVENT,differential_pladb10mm_introns$EVENT,differential_pladb1mm_exons$EVENT,differential_pladb1mm_introns$EVENT,differential_pladb10mm_1mm_introns$EVENT,differential_pladb10mm_1mm_exons$EVENT), GENE=c(differential_pladb10mm_exons$GENE,differential_pladb10mm_introns$GENE,differential_pladb1mm_exons$GENE,differential_pladb1mm_introns$GENE,differential_pladb10mm_1mm_introns$GENE,differential_pladb10mm_1mm_exons$GENE))



ht<-Heatmap(
  pladb_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes PladB Samples at Different concentrations of PladB",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(pladb_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(pladb_matrix)

final_impact <- protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact)) %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))


# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  pladb_matrix,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_pladb$Description,
  column_dend_reorder = c(1:9),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 30))
  })
}


```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- pladb_matrix[row_order, col_order]

final_impact_string<-protein_impact %>%
  dplyr::filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-dplyr::select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))



```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr 2}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

orf_10mm_unique_exons<-differential_pladb10mm_exons[differential_pladb10mm_exons$EVENT %in% reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]],]

orf_10mm_unique_introns<-differential_pladb10mm_introns[differential_pladb10mm_introns$EVENT %in% reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]],]


```

#### GO Biological Process

```{r orf bioprocess 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction 2, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

## ORF Disrupted Splicing Events unique to 10mM PladB

These are the mannually curated top splicing events that are unique to 10mM PladB treatment and witch a gene ontology related to cell cycle, chromosomes o spindle.

```{r densities_per_event 3, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names <- c("MmuEX0014857", "MmuEX0014855", "MmuINT0153506", 
          "MmuINT1032175","MmuEX0044981")
pladb_events_shared<-filter(pladb_events$PSI, EVENT %in% event_names)

# Add GENE names to the EVENT column
pladb_events_shared <- pladb_events_shared %>%
  mutate(EVENT = paste0(EVENT, " (", GENE, ")"))

# Reshape data for plotting
pladb_events_shared <- pladb_events_shared %>%
  pivot_longer(
    cols = 7:15,
    names_to = "Condition",
    values_to = "Value"
  ) %>%
  mutate(
    Group = case_when(
      grepl("038|039|040", Condition) ~ "Control",
      grepl("041|042|043", Condition) ~ "Pladb1mM",
      grepl("044|045|046", Condition) ~ "Pladb10mM"
    )
  )

pladb_events_shared$Group<-factor(pladb_events_shared$Group, levels = c("Control","Pladb1mM","Pladb10mM"))
# Plot with updated EVENT names
ggplot(pladb_events_shared, aes(x = Group, y = Value, color = EVENT)) +
  geom_boxplot(size = 1) +
  labs(
    title = "ORF Disrupted Events unique to 10mM PladB",
    x = "",
    y = "PSI"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  ) + 
  facet_wrap(~EVENT)
```

# System Settings

```{r session info}
sessionInfo()
```


