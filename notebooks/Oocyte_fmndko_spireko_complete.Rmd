---
title: 'Oocyte Alternative Splicing Analysis'
Subtitle: "FMN2KO & SPIRE1/2KO"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    code_folding: hide
    code_download: false
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options:
  markdown:
    wrap: 72


header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        #logos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #logos img {
            height: 80px;
            margin: 0 15px;
        }
     </style>'
---



```{css, echo=FALSE}
/* Minimal and clean custom CSS */
body {
  font-family: 'Roboto', sans-serif;
  color: #333; /* Neutral dark gray for body text */
  background-color: #f9f9f9; /* Light background */
  margin: 0;
  padding: 0;
  width: 100%; /* Full width */
}

.container {
  max-width: 100%; /* Use full width of the screen */
  padding: 20px; /* Optional: add padding for better readability */
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto', sans-serif;
  font-weight: bold;
}

/* Header Colors */
h1 {
  font-size: 2.5em;
  color: #5E14C4; /* Main headers in purple */
}

h2 {
  font-size: 2em;
  color: #4A10A1; /* Darker purple for secondary headers */
}

h3 {
  font-size: 1.75em;
  color: #3B0D7E; /* Even darker purple for tertiary headers */
}

p {
  text-align: justify;
  line-height: 1.6;
  margin: 0 0 1em;
}

/* Styling for subtitle, authors, and date */
.subtitle, .author, .date {
  color: #5E14C4;
  font-size: 1.25em;
  text-align: center;
  margin-bottom: 0.5em;
}

/* Link styling */
a {
  color: #5E14C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Table styling */
table {
  border-collapse: collapse;
  width: 100%;
  margin: 20px 0;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 10px;
}

table th {
  background-color: #5E14C4;
  color: white;
}

table tr:nth-child(even) {
  background-color: #f9f9f9;
}

table tr:hover {
  background-color: #f1f1f1;
}

```



```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)


# Load required libraries
library("betAS")
library("ggplot2")
library("plotly")
library("dplyr")
library("tidyverse")
library("cowplot")
library("DT")
library("paletteer")
library("ggupset")
library("showtext")
library("ggtext")
library("readxl")
library("biomaRt")
library("patchwork")
library("org.Mm.eg.db")
library("org.Hs.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ComplexHeatmap")
library("enrichR")
library("colorRamp2")
library("dendextend")
# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"

```

# Introduction to this Analysis

## Part 1: Upstream Analysis

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**:
  - Downloading `*.fastq.gz` files from 3 different studies:
    - **FMN2 DKO Oocytes**
    - **SPIRE1/2 DKO Oocytes**
  - Merging technical replicates for superior sequencing depth

2. **Alignment**:
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## Part 2: Statistical Analysis

### Objective
To identify splicing events that are differentially spliced in Oocytes modified to be FMN2 DKO or SPIRE1/2 DKO.

### Steps

1. **Statistical Testing**:
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform Beta Distribution simulations, T-test and ANOVA to obtain:
     - **False Discovery Rate (FDR)**
     - **F-statistic**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.1**

3. **Batch Effect Mitigation**:
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation. All exon related events (C1,C2,C3,S,including microexons) will be collapsed into a single list, EX.

---

## Importing Inclusion Data

```{r inclusion tables}

fmndko_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/fmndko_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
fmndko_events <- getEvents(fmndko_data, tool = "vast-tools") # Extract alternative splicing events

fmndko_exons <- filterEvents(fmndko_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 4)
fmndko_introns <- filterEvents(fmndko_events, types = c("IR"), N = 4)
fmndko_alt <- filterEvents(fmndko_events, types = c("Alt5", "Alt3"), N = 4)



spire_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/spiredko_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
spire_events <- getEvents(spire_data, tool = "vast-tools") # Extract alternative splicing events

spire_exons <- filterEvents(spire_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 4)
spire_introns <- filterEvents(spire_events, types = c("IR"), N = 4)
spire_alt <- filterEvents(spire_events, types = c("Alt5", "Alt3"), N = 4)


```


## Metadata { .tabset}

### FMN2DKO

```{r metadata fmn2dko}
# Load metadata file containing sample information
metadata_fmn2dko<-data.frame(samples=c("SRR6026682_SRR6026683_SRR6026684_merged","SRR6026685_SRR6026686_SRR6026687_merged","SRR6026688_SRR6026689_SRR6026690_merged","SRR6026691_SRR6026692_SRR6026693_merged"),condition=c("control","control","fmndko","fmndko"))
DT::datatable(metadata_fmn2dko, options = list(pageLength = nrow(metadata_fmn2dko), scrollX = TRUE))
```

### Spire

```{r metadata tao}
# Load metadata file containing sample information
metadata_spire<-data.frame(samples=c("Oocytes_FG_Spire12_Cont_a","Oocytes_FG_Spire12_Cont_b","Oocytes_FG_Spire12_Cont_c","Oocytes_FG_Spire12_DKO_a","Oocytes_FG_Spire12_DKO_b","Oocytes_FG_Spire12_DKO_c"), condition=rep(c("control", "spiredko"), each=3))
DT::datatable(metadata_spire, options = list(pageLength = nrow(metadata_spire), scrollX = TRUE))
```


---



# Total Splicing Events

This plot shows the total number of splicing events found during the **mapping**, alongside the proportions of each type of event. It is important to know that *vast-tools* does not find new events, but it identifies those manually curated in the database. The total number is the same for both datasets, as it is the total number of events registered and curated in ***VASTDB***, hence the *Complete Version.* 


```{r splicing events barplot stacked}

# Adjusted version of the script
splicing_events <- tibble(
  event_type = names(spire_events$EventsPerType),
  spire = spire_events$EventsPerType,
  fmndko = fmndko_events$EventsPerType
)

splicing_events_long <- splicing_events %>%
  pivot_longer(cols = c(spire, fmndko),
               names_to = "study", values_to = "count") %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

# Proportion bar plot
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) +
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "<b style='font-size:18px;'>Proportion of Splicing Events by Study</b>",
    x = NULL,
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal(base_family = font) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_markdown(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5)
  ) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

splicing_events_long_sum<-splicing_events_long %>%
  dplyr::group_by(study) %>%
  summarize(count = sum(count))


# Absolute counts plot
plot_absolute <- ggplot(splicing_events_long_sum, aes(y = count, x = study)) +
  geom_point(color = "#C70039", size = 3) +
  geom_text(aes(label = count), vjust = -1, size = 4, check_overlap = TRUE) +
  labs(
    x = "Study",
    y = "Number of Events",
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text( size=15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2)))


# Combine plots
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.5)) &
  theme(plot.margin = margin(5,5, 0, 5))

# Display combined plot
combined_plot
```

```{r general stats}
vastdb_events<-read.table("EVENT_INFO-mm10.tab", header = TRUE, sep = "\t")
bin_exons <- function(n) {
  if (is.na(n)) return(NA) # Handle missing values
  else if (n < 6) return("1-5")
  else if (n < 9) return("6-10")
  else if (n < 21) return("11-20")
  else return("21+")
}

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_exons<-vastdb_events[grep("EX", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$exon_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_exons<-apply_bin_exons(vastdb_exons)

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_introns<-vastdb_events[grep("IN", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$intron_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_introns<-apply_bin_exons(vastdb_introns)

```

# Does the number of exons of a gene affect Inclusion? { .tabset}

First I classified the genes according to the number of exons they contain from VASTDB. Then I plotted the dPSI of all exons grouped by that classification.

## Exons 

### Spire

```{r inclusionumber of exons spire}

spire_exons_df<-na.omit(spire_exons$PSI)
spire_exons_df$exon_group<-vastdb_exons$exon_group[match(spire_exons_df$EVENT,vastdb_exons$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 10:12])
  avg_control <- rowMeans(df[, 7:9])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
spire_exons_df$difference <- compute_difference(spire_exons_df)

spire_exons_df$exon_group<-factor(spire_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))

spire_exons_df<-na.omit(spire_exons_df)
# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  spire_exons_df[abs(spire_exons_df$difference) > 10,], 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 100, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "Spire, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "# of Exons",
    fill = "|ΔPSI| >= 10",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```

```{r splice site score}

# Read the splice scores
splice_scores <- read.table("SPLICE_SITE_SCORES-mm10.tab", header = FALSE, sep = "\t", col.names = c("EVENT", "V2", "V3"))
colnames(splice_scores)<-c("EVENT","seq","scores")

# Ensure each EVENT has exactly two rows, then reshape
spire_exons_df <- spire_exons_df %>%
  left_join(splice_scores %>% select(EVENT, scores), by = "EVENT") %>%
  group_by(EVENT) %>%
  mutate(score_index = row_number()) %>%  # Assign 1st and 2nd match indexes
  pivot_wider(names_from = score_index, values_from = scores, names_prefix = "score_") %>%
  rename(splice_score_5 = score_1, splice_score_3 = score_2) %>%  # Ensure correct ordering
  ungroup()

```




### FMNDKO

```{r inclusionumber of exons fmndko}
fmndko_exons_df<-na.omit(fmndko_exons$PSI)
fmndko_exons_df$exon_group<-vastdb_exons$exon_group[match(fmndko_exons_df$EVENT,vastdb_exons$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 9:10])
  avg_control <- rowMeans(df[, 7:8])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
fmndko_exons_df$difference <- compute_difference(fmndko_exons_df)


# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  fmndko_exons_df[abs(fmndko_exons_df$difference) >= 10,], 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "FMNDKO, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```

## Introns

### Spire

```{r inclusionumber of introns spire}
spire_introns_df<-na.omit(spire_introns$PSI)
spire_introns_df$intron_group<-vastdb_introns$intron_group[match(spire_introns_df$EVENT,vastdb_introns$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 10:12])
  avg_control <- rowMeans(df[, 7:9])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
spire_introns_df$difference <- compute_difference(spire_introns_df)


# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  spire_introns_df[abs(spire_introns_df$difference) >= 10,], 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~intron_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Introns present in a Gene",
    subtitle = "Spire, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```

### FMNDKO

```{r inclusionumber of introns fmndko}
fmndko_introns_df<-na.omit(fmndko_introns$PSI)
fmndko_introns_df$intron_group<-vastdb_introns$intron_group[match(fmndko_introns_df$EVENT,vastdb_introns$EVENT)]


# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_KO <- rowMeans(df[, 9:10])
  avg_control <- rowMeans(df[, 7:8])
  avg_KO - avg_control
}

# Compute the difference and group by exon groups
fmndko_introns_df$difference <- compute_difference(fmndko_introns_df)


# Plot distribution of PSI difference for each exon group
plot_psi_distribution <- ggplot(
  fmndko_introns_df[abs(fmndko_introns_df$difference) >= 10,], 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~intron_group, scales = "fixed") +
  labs(
    title = "PSI Difference Distribution Grouped by Number of Introns present in a Gene",
    subtitle = "FMNDKO, dPSI = KO - Control",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")

print(plot_psi_distribution)


```




# PCA Plot { .tabset}


## SpireDKO

```{r pca calculation spire}
# Subset and scale data
pca_spire <- spire_data[, c("EVENT",spire_events$Samples)] %>%
  na.omit()

rownames(pca_spire)<- pca_spire$EVENT
pca_spire<-t(pca_spire[,-1])


pca_result_spire <- prcomp(pca_spire)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result_spire$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-metadata_spire$condition
```

```{r pca plotting spire}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), )) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result_spire)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result_spire)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  coord_fixed()

pca_plot

```


## FMN2DKO

```{r pca calculation fmndko}
# Subset and scale data
pca_fmndko <- fmndko_data[, c("EVENT",fmndko_events$Samples)] %>%
  na.omit()

rownames(pca_fmndko)<- pca_fmndko$EVENT
pca_fmndko<-t(pca_fmndko[,-1])


pca_result_fmndko <- prcomp(pca_fmndko)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result_fmndko$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-metadata_fmn2dko$condition
```

```{r pca plotting fmndko}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), )) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result_fmndko)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result_fmndko)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  coord_fixed()

pca_plot

```

# Differential Splicing Calculation

```{r aux_featuregroup}
# Extract unique groups and sample IDs

# fmn2dko

metadata_fmn2dko<-data.frame(samples=c("SRR6026682_SRR6026683_SRR6026684_merged","SRR6026685_SRR6026686_SRR6026687_merged","SRR6026688_SRR6026689_SRR6026690_merged","SRR6026691_SRR6026692_SRR6026693_merged"),condition=c("control","control","fmndko","fmndko"))
groups_fmndko <- unique(metadata_fmn2dko[, "condition"])
samples_fmndko <- metadata_fmn2dko$samples

# spiredko

groups_spire <- unique(metadata_spire[, "condition"])
samples_spire <- metadata_spire$samples


random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")


# Create group list with metadata
groupList_fmndko <- lapply(1:length(groups_fmndko), function(i) {
  list(
    name = groups_fmndko[i],
    samples = samples_fmndko[metadata_fmn2dko[, "condition"] == groups_fmndko[i]],
    color = random_colors[i]
  )
})
names(groupList_fmndko) <- groups_fmndko

# Create group list with metadata
groupList_spire <- lapply(1:length(groups_spire), function(i) {
  list(
    name = groups_spire[i],
    samples = samples_spire[metadata_spire[, "condition"] == groups_spire[i]],
    color = random_colors[i]
  )
})
names(groupList_spire) <- groups_spire

```

```{r groups_auxiliary}
# Define groups

groupA_fmndko<-"control"
groupB_fmndko<-"fmndko"

groupA_spire<-"control"
groupB_spire<-"spiredko"


samplesA_fmndko <- groupList_fmndko[[groupA_fmndko]]$samples
samplesB_fmndko <- groupList_fmndko[[groupB_fmndko]]$samples
colsGroupA_fmndko <- convertCols(fmndko_exons$PSI, samplesA_fmndko)
colsGroupB_fmndko <- convertCols(fmndko_exons$PSI, samplesB_fmndko)

samplesA_spire <- groupList_spire[[groupA_spire]]$samples
samplesB_spire <- groupList_spire[[groupB_spire]]$samples
colsGroupA_spire <- convertCols(spire_exons$PSI, samplesA_spire)
colsGroupB_spire <- convertCols(spire_exons$PSI, samplesB_spire)


set.seed(42) #Setting seed for downstream simulations of the beta distribution
```

## Exon Lists

### Calculations

```{r pdiff calculation exons}

# Prepare table for fmn2dko
fmndko_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = fmndko_exons$PSI,
  qualtable = fmndko_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_fmndko,
  colsB = colsGroupB_fmndko,
  labA = groupA_fmndko,
  labB = groupB_fmndko,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE,
  CoverageWeight = FALSE
)

# Prepare table for spire
spire_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = spire_exons$PSI,
  qualtable = spire_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_spire,
  colsB = colsGroupB_spire,
  labA = groupA_spire,
  labB = groupB_spire,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE,
  CoverageWeight = FALSE
)

differential_spire_exons<-na.omit(spire_pdiff_exons[spire_pdiff_exons$FDR <= 0.1,])
differential_fmndko_exons<-na.omit(fmndko_pdiff_exons[fmndko_pdiff_exons$FDR <= 0.1,])

shared_exons<-differential_spire_exons$EVENT[differential_spire_exons$EVENT %in% differential_fmndko_exons$EVENT]
```




### Volcano Plots { .tabset}


#### FMN2DKO

```{r fmndko fdr volcano exons}

library(ggrepel)
fmndko_pdiff_exons<-na.omit(fmndko_pdiff_exons)
# Add a Shared column based on the shared_exons
fmndko_pdiff_exons$Shared <- ifelse(fmndko_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
fmndko_pdiff_exons$Significant <- ifelse(
  fmndko_pdiff_exons$FDR <=0.1 & fmndko_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    fmndko_pdiff_exons$FDR <=0.1 & fmndko_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
fmndko_pdiff_exons$negLogpvalue <- -log10(fmndko_pdiff_exons$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(fmndko_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of FMN2DKO Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot



```

#### Spire2

```{r spire fdr volcano exons}
spire_pdiff_exons<-na.omit(spire_pdiff_exons)
# Add a Shared column based on the shared_exons
spire_pdiff_exons$Shared <- ifelse(spire_pdiff_exons$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
spire_pdiff_exons$Significant <- ifelse(
  spire_pdiff_exons$FDR <=0.1 & spire_pdiff_exons$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    spire_pdiff_exons$FDR <=0.1 & spire_pdiff_exons$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
spire_pdiff_exons$negLogpvalue <- -log10(spire_pdiff_exons$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(spire_pdiff_exons, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of Spire Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot


```


### Individual Combination Tables { .tabset}

These tables show the exons that show FDR <= 0.1 in the pairwise comparison of each condition. The delta PSI is *not* filtered yet (so you can download the complete version of the spreadsheet).


#### FMN2DKO

```{r fmndko combination table exons}
# Render DataTable with enhancements
datatable(
  differential_fmndko_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### Spire2


```{r spire combination table exons}
# Render DataTable with enhancements
datatable(
  differential_spire_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```



## Intron Lists

### Calculations

```{r pdiff calculation introns}


# Prepare table for Tao
fmndko_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = fmndko_introns$PSI,
  qualtable = fmndko_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_fmndko,
  colsB = colsGroupB_fmndko,
  labA = groupA_fmndko,
  labB = groupB_fmndko,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE,
  CoverageWeight = FALSE
)

# Prepare table for spire
spire_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = spire_introns$PSI,
  qualtable = spire_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_spire,
  colsB = colsGroupB_spire,
  labA = groupA_spire,
  labB = groupB_spire,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=100,
  seed = TRUE,
  CoverageWeight = FALSE
)

differential_spire_introns<-na.omit(spire_pdiff_introns[spire_pdiff_introns$FDR <=0.1,])
differential_fmndko_introns<-na.omit(fmndko_pdiff_introns[fmndko_pdiff_introns$FDR <=0.1,])

shared_introns<-differential_spire_introns$EVENT[differential_spire_introns$EVENT %in% differential_fmndko_introns$EVENT]
```



### Volcano Plots { .tabset}



```{r fmndko volcano introns}
fmndko_pdiff_introns<-na.omit(fmndko_pdiff_introns)
# Add a Shared column based on the shared_exons
fmndko_pdiff_introns$Shared <- ifelse(fmndko_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
fmndko_pdiff_introns$Significant <- ifelse(
  fmndko_pdiff_introns$FDR <=0.1 & fmndko_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    fmndko_pdiff_introns$FDR <=0.1 & fmndko_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
fmndko_pdiff_introns$negLogpvalue <- -log10(fmndko_pdiff_introns$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(fmndko_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of FMN2DKO Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot




```

#### Spire2

```{r spire volcano introns}
spire_pdiff_introns<-na.omit(spire_pdiff_introns)
spire_pdiff_introns$Shared <- ifelse(spire_pdiff_introns$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
spire_pdiff_introns$Significant <- ifelse(
  spire_pdiff_introns$FDR <=0.1 & spire_pdiff_introns$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    spire_pdiff_introns$FDR <=0.1 & spire_pdiff_introns$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
spire_pdiff_introns$negLogpvalue <- -log10(spire_pdiff_introns$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(spire_pdiff_introns, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of Spire Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot




```

### Individual Combination Tables { .tabset}

These tables show the introns that show FDR <= 0.1 in the pairwise comparison of each condition. The delta PSI is *not* filtered yet (so you can download the complete version of the spreadsheet).


#### FMN2DKO



```{r fmndko combination table introns}
# Render DataTable with enhancements
datatable(
  differential_fmndko_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### Spire2


```{r spire combination table introns}
# Render DataTable with enhancements
datatable(
  differential_spire_introns,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```


## Alternative Splicing List

### Calculations

```{r pdiff calculation alt}

# Prepare table for Tao
fmndko_pdiff_alt <- prepareTableVolcanoFDR(
  psitable = fmndko_alt$PSI,
  qualtable = fmndko_alt$Qual,
  npoints = 500,
  colsA = colsGroupA_fmndko,
  colsB = colsGroupB_fmndko,
  labA = groupA_fmndko,
  labB = groupB_fmndko,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=100,
  seed = TRUE,
  CoverageWeight = FALSE
)

# Prepare table for spire
spire_pdiff_alt <- prepareTableVolcanoFDR(
  psitable = spire_alt$PSI,
  qualtable = spire_alt$Qual,
  npoints = 500,
  colsA = colsGroupA_spire,
  colsB = colsGroupB_spire,
  labA = groupA_spire,
  labB = groupB_spire,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=100,
  seed = TRUE,
  CoverageWeight = FALSE
)

differential_spire_alt<-na.omit(spire_pdiff_alt[spire_pdiff_alt$FDR <=0.1,])
differential_fmndko_alt<-na.omit(fmndko_pdiff_alt[fmndko_pdiff_alt$FDR <=0.1,])

shared_alt<-differential_spire_alt$EVENT[differential_spire_alt$EVENT %in% differential_fmndko_alt$EVENT]
```




### Volcano Plots { .tabset}


#### FMN2DKO

```{r fmndko  volcano alt}
fmndko_pdiff_alt<-na.omit(fmndko_pdiff_alt)
fmndko_pdiff_alt$Shared <- ifelse(fmndko_pdiff_alt$EVENT %in% shared_alt, "Shared", "Not Shared")

# Classify significance
fmndko_pdiff_alt$Significant <- ifelse(
  fmndko_pdiff_alt$FDR <=0.1 & fmndko_pdiff_alt$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    fmndko_pdiff_alt$FDR <=0.1 & fmndko_pdiff_alt$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
fmndko_pdiff_alt$negLogpvalue <- -log10(fmndko_pdiff_alt$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(fmndko_pdiff_alt, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of FMN2DKO Alternative 5´/3´",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot



```

#### Spire2

```{r spire fdr volcano alt}
spire_pdiff_alt<-na.omit(spire_pdiff_alt)
spire_pdiff_alt$Shared <- ifelse(spire_pdiff_alt$EVENT %in% shared_alt, "Shared", "Not Shared")

# Classify significance
spire_pdiff_alt$Significant <- ifelse(
  spire_pdiff_alt$FDR <=0.1 & spire_pdiff_alt$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    spire_pdiff_alt$FDR <=0.1 & spire_pdiff_alt$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
spire_pdiff_alt$negLogpvalue <- -log10(spire_pdiff_alt$FDR)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(spire_pdiff_alt, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 4,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](FDR)),
    title = "Volcano Plot of Spire Alternative 5´/3´",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "Arial") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot



```

### Individual Combination Tables { .tabset}

These tables show the Alt5 or Alt3 that show FDR <= 0.1 in the pairwise comparison of each condition. The delta PSI is *not* filtered yet (so you can download the complete version of the spreadsheet).

#### FMN2DKO


```{r fmndko combination table alt}
# Render DataTable with enhancements
datatable(
  differential_fmndko_alt,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```

#### Spire2



```{r spire combination table alt}
# Render DataTable with enhancements
datatable(
  differential_spire_alt,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "FDR",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```



## Enrichment Analysis with EnrichR { .tabset}


### FMN2DKO { .tabset}

```{r fmndko enrichr}
enrichdata<-enrichr(unique(c(differential_fmndko_exons$GENE, differential_fmndko_introns$GENE, differential_fmndko_alt$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))


```


#### GO Biological Process

```{r fmndko bioprocess, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[1]])

datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r fmndko cellcomponent, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[2]])

datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r fmndko molfunction, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

### Spire { .tabset}

```{r spire enrichr}
enrichdata<-enrichr(unique(c(differential_spire_exons$GENE, differential_spire_introns$GENE, differential_spire_alt$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))


```

#### GO Biological Process

```{r spire bioprocess, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r spire cellcomponent, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r spire molfunction, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```


# Nuclear Speckle Protein Splicing Correlation { .tabset}

Nuclear speckles genes were obtained from the Human Protein Atlas
Differentially spliced events were filtered to obtain those proteins localizing within speckles. I performed pearson correlation between those selected events. In adittion to the FDR threshold, they also need to have a |dPSI|>=0.1.

## Spire

```{r nuclear spckeles data hadnling spire}
set.seed(43)
speckles_proteins<-read_tsv("nuclear_speckles_protein_human_atlas.tsv")

spire_speckle_prots <- spire_events$PSI %>%
  filter((EVENT %in% differential_spire_exons$EVENT[
            tolower(differential_spire_exons$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_spire_exons$deltapsi) >= 0.1]) |
         (EVENT %in% differential_spire_introns$EVENT[
            tolower(differential_spire_introns$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_spire_introns$deltapsi) >= 0.1]) |
         (EVENT %in% differential_spire_alt$EVENT[
            tolower(differential_spire_alt$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_spire_alt$deltapsi) >= 0.1]))




rownames(spire_speckle_prots)<-spire_speckle_prots$EVENT

spire_speckle_prots_t <- t(spire_speckle_prots[,7:12])

# Calculate correlation between genes
cor_matrix <- cor(spire_speckle_prots_t)

heatmap <- Heatmap(cor_matrix,
                   name = "Correlation",
                   clustering_distance_rows = "euclidean",  # Row clustering method
                   clustering_method_rows = "complete",     # Clustering method for rows
                   show_row_dend = TRUE,                    # Show row dendrogram
                   show_column_dend = TRUE,                 # Show column dendrogram
                   column_title = "Correlation Heatmap",    # Title for the heatmap
                   row_title = "Variables",                 # Title for rows
                   column_title_gp = gpar(fontsize = 14),   # Title formatting
                   row_title_gp = gpar(fontsize = 14)       # Row title formatting
)

# Draw the heatmap
draw(heatmap)

```

```{r table speckles spire}
# Render DataTable with enhancements

datatable(
  spire_speckle_prots,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```



## FMNDKO

```{r nuclear spckeles data hadnling fmndko}
set.seed(43)

fmndko_speckle_prots <- fmndko_events$PSI %>%
  filter((EVENT %in% differential_fmndko_exons$EVENT[
            tolower(differential_fmndko_exons$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_fmndko_exons$deltapsi) >= 0.1]) |
         (EVENT %in% differential_fmndko_introns$EVENT[
            tolower(differential_fmndko_introns$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_fmndko_introns$deltapsi) >= 0.1]) |
         (EVENT %in% differential_fmndko_alt$EVENT[
            tolower(differential_fmndko_alt$GENE) %in% tolower(speckles_proteins$Gene) & 
            abs(differential_fmndko_alt$deltapsi) >= 0.1]))




rownames(fmndko_speckle_prots)<-fmndko_speckle_prots$EVENT

fmndko_speckle_prots_t <- t(fmndko_speckle_prots[,7:10])

# Calculate correlation between genes
cor_matrix <- cor(fmndko_speckle_prots_t)

heatmap <- Heatmap(cor_matrix,
                   name = "Correlation",
                   clustering_distance_rows = "euclidean",  # Row clustering method
                   clustering_method_rows = "complete",     # Clustering method for rows
                   show_row_dend = TRUE,                    # Show row dendrogram
                   show_column_dend = TRUE,                 # Show column dendrogram
                   column_title = "Correlation Heatmap",    # Title for the heatmap
                   row_title = "Variables",                 # Title for rows
                   column_title_gp = gpar(fontsize = 14),   # Title formatting
                   row_title_gp = gpar(fontsize = 14)       # Row title formatting
)

# Draw the heatmap
draw(heatmap)

```

```{r table speckles fmndko}
# Render DataTable with enhancements


datatable(
  fmndko_speckle_prots,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# Splicing Dynamics Heatmap Spire

From now, onwards, only events with |dPSI|>=0.1 are considered.

```{r heatmap pre-prep, results='hide', fig.show='hide'}

# Extract all events
spire_all <- filterEvents(
  spire_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR","Alt3","Alt5"),
  N = 3
)
```

```{r heatmap prep, results='hide', fig.show='hide'}
set.seed(44)

spire_unique <- spire_all$PSI %>% distinct(EVENT, .keep_all = TRUE) 

spire_unique<-spire_unique[-which(is.na(spire_unique$EVENT)),]
# Set rownames and convert to matrix
rownames(spire_unique) <- spire_unique$EVENT
spire_unique <- as.matrix(spire_unique[,7:12])

# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_spire_exons[abs(differential_spire_exons$deltapsi)>=0.1, "EVENT"],
  differential_spire_introns[abs(differential_spire_introns$deltapsi)>=0.1, "EVENT"]
  ))
spire_unique <- spire_unique[rownames(spire_unique) %in% filtered_events, ]

# Create a dendrogram for the columns
col_dend <- hclust(dist(t(spire_unique))) %>%
  as.dendrogram() %>%
  color_branches(k = 2) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(spire_unique))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-4


reference_table<-data.frame(EVENT=c(differential_fmndko_exons[abs(differential_fmndko_exons$deltapsi)>=0.1, "EVENT"],differential_fmndko_introns[abs(differential_fmndko_introns$deltapsi)>=0.1, "EVENT"],differential_spire_exons[abs(differential_spire_exons$deltapsi)>=0.1, "EVENT"],differential_spire_introns[abs(differential_spire_introns$deltapsi)>=0.1, "EVENT"]), GENE=c(differential_fmndko_exons[abs(differential_fmndko_exons$deltapsi)>=0.1, "GENE"],differential_fmndko_introns[abs(differential_fmndko_introns$deltapsi)>=0.1, "GENE"],differential_spire_exons[abs(differential_spire_exons$deltapsi)>=0.1, "GENE"],differential_spire_introns[abs(differential_spire_introns$deltapsi)>=0.1, "GENE"]))



ht<-Heatmap(
  spire_unique, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes  Samples at Different concentrations of ",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_dend_reorder = c(1:6),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,
  na_col = "transparent"

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(spire_unique)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(spire_unique)

final_impact <- protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact)) %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))


# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  spire_unique,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 18, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:6),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 30))
  })
}

```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- spire_unique[row_order, col_order]

final_impact_string<-protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

heatmap_dataframe_spire<-heatmap_dataframe
# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))



```


### Same Heatmap but averaging PSI values from same condition

```{r heatmap_plot short, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

spire_unique_short <- cbind(
  rowMeans(spire_unique[, 1:3]),
  rowMeans(spire_unique[, 4:6])
)

# Convert to matrix and print result
colnames(spire_unique_short) <- c("Control", "SpireKO")

spire_unique_short <- spire_unique_short[row_order,]

ht <- Heatmap(
  spire_unique_short,
  name = "PSI",
  col = col_fun,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:3),
  cluster_rows = FALSE,   # <-- This disables row clustering
  cluster_columns = FALSE, # Optionally disable column clustering if desired
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"),      # Adjust the gap size between rows
  left_annotation = left_annotation[row_order],   # Add the points on the left
  right_annotation = right_annotation[row_order],
  column_gap = unit(4, "mm"),   # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend vertically
  )
)

# Draw the heatmap
ht <- draw(ht)

# Draw the heatmap




```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr}
enrichdata<-enrichr(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]], databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))



```

#### GO Biological Process

```{r orf bioprocess, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])

datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# Splicing Dynamics Heatmap FMNDKO

```{r heatmap prep fmndko, results='hide', fig.show='hide'}
set.seed(44)

fmndko_all <- filterEvents(
  fmndko_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR","Alt3","Alt5"),
  N = 3
)

fmndko_unique <- fmndko_all$PSI %>% distinct(EVENT, .keep_all = TRUE) 

fmndko_unique<-fmndko_unique[-which(is.na(fmndko_unique$EVENT)),]
# Set rownames and convert to matrix
rownames(fmndko_unique) <- fmndko_unique$EVENT
fmndko_unique <- as.matrix(fmndko_unique[,7:10])

# Filter rows based on the final event lists and with abs(deltapsi)>=0.1
filtered_events <- unique(c(
  differential_fmndko_exons[abs(differential_fmndko_exons$deltapsi)>=0.1, "EVENT"],
  differential_fmndko_introns[abs(differential_fmndko_introns$deltapsi)>=0.1, "EVENT"]
  ))
fmndko_unique <- fmndko_unique[rownames(fmndko_unique) %in% filtered_events, ]

# Arrange columns based on metadata
# Create a dendrogram for the columns
col_dend <- hclust(dist(t(fmndko_unique))) %>%
  as.dendrogram() %>%
  color_branches(k = 2) # Color branches with 3 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(fmndko_unique))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-5




ht<-Heatmap(
  fmndko_unique, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Oocytes  Samples at Different concentrations ",
  row_title = "Splicing Events of |dPSI|>=0.1",
  column_names_rot = 45,
  column_dend_reorder = c(1:4),
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,
  na_col = "transparent"

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(fmndko_unique)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t",
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(fmndko_unique)

final_impact <- protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact)) %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))


# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)

```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Biological Process* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The predicted impact on the protein appears on the left.

```{r heatmap_plot fmndko, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

ht <- Heatmap(
  fmndko_unique,
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_labels = metadata_fmn2dko$condition,
  column_dend_reorder = c(1:4),
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 30))
  })
}

```

### Table of Events from Heatmap

**Note**: the *heatmap_cluster* column references to the heatmap row cluster (from top to bottom) that specific event belongs to.

```{r, table heatmap final fmndko}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)


cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- fmndko_unique[row_order, col_order]

final_impact_string<-protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))


```

### Same Heatmap but averaging PSI values from same condition

```{r heatmap_plot short fmndko, fig.width=30, fig.height=30, echo=TRUE, out.width="100%"}
set.seed(44)

fmndko_unique_short <- cbind(
  rowMeans(fmndko_unique[, 1:2]),
  rowMeans(fmndko_unique[, 3:4])
)

# Convert to matrix and print result
colnames(fmndko_unique_short) <- c("Control", "FMNDKO")

fmndko_unique_short <- fmndko_unique_short[row_order,]

ht <- Heatmap(
  fmndko_unique_short,
  name = "PSI",
  col = col_fun,
  column_title = "Oocytes Samples",
  column_title_gp = gpar(fontsize = 24, fontface = "bold"),
  row_title = "Splicing Events of |dPSI| >= 0.1",
  row_title_gp = gpar(fontsize = 28, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:3),
  cluster_rows = FALSE,   # <-- This disables row clustering
  cluster_columns = FALSE, # Optionally disable column clustering if desired
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"),      # Adjust the gap size between rows
  left_annotation = left_annotation[row_order],   # Add the points on the left
  right_annotation = right_annotation[row_order],
  column_gap = unit(4, "mm"),   # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 30),
    labels_gp = gpar(fontsize = 30),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend vertically
  )
)

# Draw the heatmap
ht <- draw(ht)

# Draw the heatmap




```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr fmndko}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))



```

#### GO Biological Process

```{r orf bioprocess fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```



# System Settings

```{r session info}
sessionInfo()
```
